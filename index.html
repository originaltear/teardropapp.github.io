<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crying Map - Complete Edition</title>
    
    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg&callback=initMap&loading=async"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, orderBy, limit, deleteDoc, serverTimestamp, increment } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCvIhy5tUEeLjRKgZbJ5n5qDh5-nSFoaYA",
            authDomain: "cryingmap-ac135.firebaseapp.com",
            projectId: "cryingmap-ac135",
            storageBucket: "cryingmap-ac135.firebasestorage.app",
            messagingSenderId: "41181872008",
            appId: "1:41181872008:web:3a6ccc7e02a707f53d843d",
            measurementId: "G-W8CSWRCFXS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Make Firebase available globally
        window.auth = auth;
        window.db = db;
        window.googleProvider = googleProvider;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.updateProfile = updateProfile;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.arrayUnion = arrayUnion;
        window.arrayRemove = arrayRemove;
        window.orderBy = orderBy;
        window.limit = limit;
        window.deleteDoc = deleteDoc;
        window.serverTimestamp = serverTimestamp;
        window.increment = increment;

        // Initialize app after Firebase is ready
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.initializeApp) {
                    window.initializeApp();
                }
            }, 100);
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }

        /* Main Container */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1002;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 18px;
            font-weight: bold;
        }

        .header-action {
            background: #FF6B35;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
        }

        .calendar-header-btn {
            background: transparent;
            color: white;
            border: 2px solid #FF6B35;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .calendar-header-btn:hover {
            background: #FF6B35;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            margin-top: 60px;
            margin-bottom: 80px;
            overflow: hidden;
        }

        /* Page Styles */
        .page {
            display: none;
            height: 100%;
            width: 100%;
        }

        .page.active {
            display: block;
        }

        /* Map Page */
        #map {
            height: 100%;
            width: 100%;
        }

        .map-overlay {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            background: rgba(26, 26, 26, 0.9);
            padding: 10px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .filter-btn {
            background: transparent;
            color: white;
            border: 2px solid #555;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #FF6B35;
            border-color: #FF6B35;
        }

        .place-cry-btn {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.4);
            z-index: 1001;
        }

        /* Feed Page */
        .feed-page {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .feed-item {
            background: #2d2d2d;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #FF6B35;
        }

        .feed-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4A90E2, #667eea);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }

        /* Cry Info Modal */
        .cry-info-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a1a;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1003;
            max-height: 70vh;
            overflow-y: auto;
        }

        .cry-info-modal.active {
            transform: translateY(0);
        }

        .cry-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .cry-emoji-large {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .cry-actions {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .cry-action-btn {
            flex: 1;
            background: #3d3d3d;
            border: none;
            padding: 12px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .cry-action-btn.active {
            background: #FF6B35;
        }

        .comment-section {
            margin-top: 20px;
        }

        .comment-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .comment-input {
            flex: 1;
            background: #3d3d3d;
            border: 1px solid #555;
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
            font-size: 14px;
        }

        .comment-submit-btn {
            background: #FF6B35;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }

        .comment-item {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .comment-author {
            font-weight: bold;
            color: #4A90E2;
            font-size: 14px;
        }

        .comment-time {
            font-size: 12px;
            color: #999;
        }

        .comment-text {
            font-size: 14px;
            color: #ccc;
            line-height: 1.4;
        }

        .delete-comment-btn {
            background: none;
            border: none;
            color: #ff4757;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 8px;
        }

        /* Rating Stars */
        .rating-stars {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .star {
            font-size: 24px;
            cursor: pointer;
            color: #555;
            transition: color 0.2s;
        }

        .star.filled {
            color: #FFD700;
        }

        .star.half {
            position: relative;
            color: #555;
        }

        .star.half::before {
            content: '★';
            position: absolute;
            left: 0;
            width: 50%;
            overflow: hidden;
            color: #FFD700;
        }

        /* Calendar View */
        .calendar-container {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav-btn {
            background: #3d3d3d;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            color: #999;
            padding: 10px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: #2d2d2d;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            font-size: 14px;
        }

        .calendar-day.has-cry {
            background: #3d3d3d;
            border: 1px solid #FF6B35;
        }

        .calendar-day-number {
            font-weight: bold;
        }

        .calendar-cry-count {
            font-size: 10px;
            color: #FF6B35;
            margin-top: 2px;
        }

        /* Search Box */
        .search-container {
            background: #2d2d2d;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            background: #3d3d3d;
            border: 1px solid #555;
            border-radius: 10px;
            padding: 12px;
            color: white;
            font-size: 16px;
        }

        .search-filters {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .search-filter-btn {
            background: #3d3d3d;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }

        .search-filter-btn.active {
            background: #FF6B35;
        }

        /* Profile Page */
        .profile-page {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 36px;
            color: white;
            font-weight: bold;
        }

        .profile-username {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .member-since {
            color: #999;
            font-size: 14px;
        }

        .profile-bio {
            color: #ccc;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .profile-btn {
            background: #555;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .stat-item {
            text-align: center;
            background: #2d2d2d;
            padding: 15px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-item:hover {
            transform: scale(1.05);
            background: #3d3d3d;
        }

        .stat-item.clickable {
            border: 2px solid #FF6B35;
            background: #3d3d3d;
        }

        .stat-item.clickable:hover {
            background: #FF6B35;
            color: white;
        }

        .stat-item.clickable:hover .stat-number {
            color: white;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #FF6B35;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        /* Achievement System */
        .achievements-container {
            margin: 30px 0;
        }

        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .achievements-title {
            font-size: 18px;
            font-weight: bold;
        }

        .achievement-progress {
            font-size: 14px;
            color: #999;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .achievement-item {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s;
        }

        .achievement-item:hover {
            transform: scale(1.05);
        }

        .achievement-item.unlocked {
            background: linear-gradient(45deg, #FF6B35, #F7931E);
        }

        .achievement-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .achievement-item.locked .achievement-icon {
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .achievement-name {
            font-size: 12px;
            font-weight: bold;
        }

        .achievement-description {
            font-size: 10px;
            color: #999;
            margin-top: 5px;
        }

        .achievement-progress-bar {
            height: 4px;
            background: #555;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .achievement-progress-fill {
            height: 100%;
            background: #FF6B35;
            transition: width 0.3s;
        }

        /* History Tab */
        .history-container {
            padding: 20px;
        }

        .history-item {
            background: #2d2d2d;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: #3d3d3d;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-emoji {
            font-size: 24px;
        }

        .history-date {
            font-size: 14px;
            color: #999;
        }

        .history-location {
            font-size: 14px;
            color: #ccc;
        }

        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .history-action-btn {
            background: #3d3d3d;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Notifications Page */
        .notifications-page {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .friend-request-item {
            background: #2d2d2d;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #4A90E2;
        }

        .friend-request-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .accept-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
        }

        .decline-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Settings Page */
        .settings-page {
            height: 100%;
            overflow-y: auto;
        }

        .settings-section {
            border-bottom: 1px solid #333;
        }

        .section-header {
            padding: 20px;
            background: #1a1a1a;
            font-size: 16px;
            font-weight: bold;
            color: #FF6B35;
        }

        .setting-item {
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .setting-item:hover {
            background: #2d2d2d;
        }

        .setting-title {
            font-weight: 600;
        }

        .setting-action {
            color: #4A90E2;
            font-size: 20px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a1a;
            border-top: 1px solid #333;
            display: flex;
            z-index: 1000;
            height: 80px;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #999;
            position: relative;
        }

        .nav-item.active {
            color: #FF6B35;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 28px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            border: 1px solid #333;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #333;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Cry Modal */
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        @media (max-width: 600px) {
            .sticker-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Sticker Button with Tooltip */
        .sticker-btn {
            aspect-ratio: 1;
            border: 2px solid transparent;
            background: #3d3d3d;
            border-radius: 10px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .sticker-btn:hover {
            transform: scale(1.1);
        }

        .sticker-btn.selected {
            border-color: #FF6B35;
            background: #FF6B35;
        }

        /* Tooltip styling */
        .sticker-btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            max-width: 200px;
            text-align: center;
            z-index: 1000;
            pointer-events: none;
            margin-bottom: 5px;
        }

        .sticker-btn[title]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            margin-bottom: -5px;
        }

        /* Form Elements */
        .form-group {
            margin: 20px 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            background: #3d3d3d;
            border: 1px solid #555;
            border-radius: 10px;
            padding: 12px;
            color: white;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: #FF6B35;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Search Results */
        .search-result-item {
            background: #2d2d2d;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .add-friend-btn {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
        }

        .add-friend-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .add-friend-btn.pending {
            background: #FFB347;
        }

        .add-friend-btn.friends {
            background: #4CAF50;
        }

        /* Mini Map */
        .mini-map {
            height: 200px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: #555;
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #FF6B35;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 24px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Edit Profile Modal */
        .edit-option {
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }

        .edit-option:hover {
            background: #2d2d2d;
        }

        .edit-icon {
            font-size: 24px;
        }

        /* User Profile Modal */
        #userProfileModal .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        #userProfileModal .profile-avatar {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            font-size: 30px;
        }

        #userProfileModal .profile-bio {
            color: #ccc;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
            text-align: center;
        }

        #userProfileModal .stats-grid {
            margin: 20px 0;
        }

        #userProfileModal .submit-btn {
            max-width: 200px;
            margin: 0 auto;
        }

        /* Blocked Users Item */
        .blocked-user-item {
            background: #2d2d2d;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .unblock-btn {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Edit Cry Modal */
        .datetime-input {
            width: 100%;
            background: #3d3d3d;
            border: 1px solid #555;
            border-radius: 10px;
            padding: 12px;
            color: white;
            font-size: 16px;
        }

        /* Profile Tabs */
        .profile-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 1px solid #333;
        }

        #criesModal .profile-tabs {
            margin-top: 0;
        }

        .profile-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #999;
            font-size: 14px;
            cursor: pointer;
            position: relative;
        }

        .profile-tab.active {
            color: #FF6B35;
        }

        .profile-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #FF6B35;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .sticker-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .achievements-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
        /* Mobile tooltip styling */
        @media (min-width: 481px) {
            .sticker-description {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .sticker-description {
                font-size: 11px;
                color: #999;
                text-align: center;
                margin-top: 10px;
                min-height: 30px;
                padding: 5px;
                background: #2d2d2d;
                border-radius: 8px;
            }
        }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="app-header">
            <div class="header-title" id="headerTitle">Map</div>
            <div style="display: flex; align-items: center;">
                <button class="calendar-header-btn" id="calendarBtn" onclick="openCalendarModal()" style="display: none;">📅</button>
                <button class="header-action" id="headerAction" onclick="handleHeaderAction()" style="display: none;">Add Friends</button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Map Page -->
            <div class="page active" id="mapPage">
                <div id="map"></div>
                <div class="map-overlay">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="global" onclick="setFilter('global')">Global</button>
                        <button class="filter-btn" data-filter="friends" onclick="setFilter('friends')">Friends</button>
                        <button class="filter-btn" data-filter="mine" onclick="setFilter('mine')">Mine</button>
                    </div>
                </div>
                <button class="place-cry-btn" onclick="openCryModal()">
                    😭 Place your cry
                </button>
                
                <!-- Cry Info Modal (Bottom Sheet) -->
                <div class="cry-info-modal" id="cryInfoModal">
                    <div class="cry-info-header">
                        <h3 id="cryInfoTitle">Cry Details</h3>
                        <button class="close-btn" onclick="closeCryInfo()">×</button>
                    </div>
                    
                    <div style="text-align: center;">
                        <div class="cry-emoji-large" id="cryInfoEmoji">😢</div>
                        <h4 id="cryInfoName">Crying</h4>
                        <p style="color: #999; font-size: 14px;" id="cryInfoUser">by @username</p>
                        <p style="color: #ccc; font-size: 14px;" id="cryInfoLocation">Location</p>
                        <p style="color: #999; font-size: 12px;" id="cryInfoTime">Time</p>
                    </div>

                    <div class="rating-stars" id="cryInfoRating" style="justify-content: center;">
                        <span class="star">★</span>
                        <span class="star">★</span>
                        <span class="star">★</span>
                        <span class="star">★</span>
                        <span class="star">★</span>
                    </div>

                    <p style="color: #ccc; font-style: italic; margin: 15px 0; text-align: center;" id="cryInfoDescription"></p>

                    <div class="cry-actions">
                        <button class="cry-action-btn" id="likeCryBtn" onclick="toggleLikeCry()">
                            <span id="likeIcon">🤍</span>
                            <span id="likeCount">0</span>
                        </button>
                        <button class="cry-action-btn" onclick="toggleComments()">
                            💬 <span id="commentCount">0</span>
                        </button>
                        <button class="cry-action-btn" id="editCryBtn" onclick="editCry()" style="display: none;">
                            ✏️ Edit
                        </button>
                        <button class="cry-action-btn" id="deleteCryBtn" onclick="deleteCry()" style="display: none; background: #ff4757;">
                            🗑️ Delete
                        </button>
                    </div>

                    <div class="comment-section" id="commentSection" style="display: none;">
                        <h4 style="margin-bottom: 15px;">Comments</h4>
                        <div class="comment-input-wrapper">
                            <input type="text" class="comment-input" id="commentInput" placeholder="Add a comment...">
                            <button class="comment-submit-btn" onclick="addComment()">Post</button>
                        </div>
                        <div id="commentsList"></div>
                    </div>
                </div>
            </div>

            <!-- Feed Page -->
            <div class="page" id="feedPage">
                <div class="feed-page">
                    <div class="empty-state" id="feedLoginRequired">
                        <div class="empty-icon">🔐</div>
                        <h3>Join the Community!</h3>
                        <p>Create an account to connect with friends and see their emotional journeys on the map.</p>
                        <button class="submit-btn" onclick="showAuthModal()" style="margin: 20px auto; max-width: 200px;">
                            Create Account
                        </button>
                    </div>
                    
                    <div class="empty-state" id="feedEmpty" style="display: none;">
                        <div class="empty-icon">👥</div>
                        <h3>No Friends Yet</h3>
                        <p>Add friends to see their emotional journeys here</p>
                        <button class="submit-btn" onclick="openAddFriendsModal()" style="margin: 20px auto; max-width: 200px;">
                            Add Your First Friend
                        </button>
                    </div>
                    
                    <div id="feedContent"></div>
                </div>
            </div>

            <!-- Profile Page -->
            <div class="page" id="profilePage">
                <div class="profile-page">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatar">G</div>
                        <div class="profile-username" id="profileUsername">Guest User</div>
                        <div class="member-since" id="memberSince">Not signed in</div>
                        <div class="profile-bio" id="profileBio"></div>
                        
                        <div class="profile-actions">
                            <button class="profile-btn" onclick="openEditProfileModal()">Edit profile</button>
                            <button class="profile-btn" onclick="shareProfile()">Share profile</button>
                            <button class="profile-btn" onclick="copyProfileLink()">🔗</button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item clickable" onclick="openCriesModal()" style="cursor: pointer; position: relative;" title="Click to view history and search">
                            <span class="stat-number" id="statCries">0</span>
                            <span class="stat-label">Cries</span>
                            <span style="position: absolute; top: 5px; right: 5px; font-size: 12px; color: #FF6B35;">📜</span>
                        </div>
                        <div class="stat-item" onclick="showFollowing()">
                            <span class="stat-number" id="statFollowing">0</span>
                            <span class="stat-label">Following</span>
                        </div>
                        <div class="stat-item" onclick="showFollowers()">
                            <span class="stat-number" id="statFollowers">0</span>
                            <span class="stat-label">Followers</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="statCountries">0</span>
                            <span class="stat-label">Countries</span>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-number" id="statAvgRating">0.00</span>
                            <span class="stat-label">Avg Rating</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="statCriesPerWeek">0.00</span>
                            <span class="stat-label">Cries/Week</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="statCriesPerMonth">0.00</span>
                            <span class="stat-label">Cries/Month</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="statCriesPerYear">0.00</span>
                            <span class="stat-label">Cries/Year</span>
                        </div>
                    </div>

                    <!-- Achievements Section -->
                    <div class="achievements-container">
                        <div class="achievements-header">
                            <div class="achievements-title">Achievements</div>
                            <div class="achievement-progress" id="achievementProgress">0/12 unlocked</div>
                        </div>
                        <div class="achievements-grid" id="achievementsGrid"></div>
                    </div>
                </div>
            </div>

            <!-- Notifications Page -->
            <div class="page" id="notificationsPage">
                <div class="notifications-page">
                    <div id="notificationsList">
                        <div class="empty-state" id="notificationsEmpty">
                            <div class="empty-icon">🔔</div>
                            <h3>No Notifications</h3>
                            <p>You'll see friend requests and updates here</p>
                        </div>
                        <div id="notificationsContent"></div>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="page" id="settingsPage">
                <div class="settings-page">
                    <!-- Privacy & Safety -->
                    <div class="settings-section">
                        <div class="section-header">Privacy & Safety</div>
                        <div class="setting-item" onclick="openPrivacySettings()">
                            <div class="setting-title">🛡️ Privacy settings</div>
                            <div class="setting-action">›</div>
                        </div>
                        <div class="setting-item" onclick="openBlockedUsers()">
                            <div class="setting-title">🚫 Blocked users</div>
                            <div class="setting-action">›</div>
                        </div>
                    </div>

                    <!-- General -->
                    <div class="settings-section">
                        <div class="section-header">General</div>
                        <div class="setting-item" onclick="openNotificationSettings()">
                            <div class="setting-title">🔔 Notifications</div>
                            <div class="setting-action">›</div>
                        </div>
                        <div class="setting-item" onclick="openFeedSettings()">
                            <div class="setting-title">📱 Feed</div>
                            <div class="setting-action">›</div>
                        </div>
                        <div class="setting-item" onclick="openStatisticsModal()">
                            <div class="setting-title">📊 Statistics</div>
                            <div class="setting-action">›</div>
                        </div>
                        <div class="setting-item" onclick="exportDataCSV()">
                            <div class="setting-title">📄 Export data (CSV)</div>
                            <div class="setting-action">›</div>
                        </div>
                        <div class="setting-item" onclick="exportData()">
                            <div class="setting-title">📋 Export data (JSON)</div>
                            <div class="setting-action">›</div>
                        </div>
                    </div>

                    <!-- About -->
                    <div class="settings-section">
                        <div class="section-header">About</div>
                        <div class="setting-item" onclick="openLink('https://instagram.com/cryingmap')">
                            <div class="setting-title">📷 Instagram</div>
                            <div class="setting-action">›</div>
                        </div>
                        <div class="setting-item" onclick="openLink('https://x.com/cryingmap')">
                            <div class="setting-title">🐦 X (Twitter)</div>
                            <div class="setting-action">›</div>
                        </div>
                        <div class="setting-item" onclick="openLink('https://cryingmap.com')">
                            <div class="setting-title">🌐 Website</div>
                            <div class="setting-action">›</div>
                        </div>
                        <div class="setting-item" onclick="openLink('mailto:support@cryingmap.com')">
                            <div class="setting-title">📧 Email</div>
                            <div class="setting-action">›</div>
                        </div>
                    </div>

                    <!-- Feedback -->
                    <div class="settings-section">
                        <div class="section-header">Feedback</div>
                        <div class="setting-item" onclick="reportProblem()">
                            <div class="setting-title">⚠️ Report a problem</div>
                            <div class="setting-action">›</div>
                        </div>
                        <div class="setting-item" onclick="makeSuggestion()">
                            <div class="setting-title">💡 Make a suggestion</div>
                            <div class="setting-action">›</div>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="settings-section">
                        <div class="section-header">Danger Zone</div>
                        <div class="setting-item" onclick="requestAccountDeletion()">
                            <div class="setting-title" style="color: #ff4757;">🗑️ Request account deletion</div>
                            <div class="setting-action">›</div>
                        </div>
                    </div>

                    <!-- App Version -->
                    <div style="padding: 20px; text-align: center; color: #666; font-size: 12px;">
                        App version: 5.1.2
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="mapPage" onclick="switchPage('mapPage')">
                <div class="nav-icon">🌍</div>
                <div class="nav-label">Map</div>
            </div>
            <div class="nav-item" data-page="feedPage" onclick="switchPage('feedPage')">
                <div class="nav-icon">👥</div>
                <div class="nav-label">Feed</div>
            </div>
            <div class="nav-item" data-page="profilePage" onclick="switchPage('profilePage')">
                <div class="nav-icon">👤</div>
                <div class="nav-label">Profile</div>
            </div>
            <div class="nav-item" data-page="notificationsPage" onclick="switchPage('notificationsPage')">
                <div class="nav-icon">🔔</div>
                <div class="nav-label">Inbox</div>
                <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
            </div>
            <div class="nav-item" data-page="settingsPage" onclick="switchPage('settingsPage')">
                <div class="nav-icon">⚙️</div>
                <div class="nav-label">Settings</div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">😭 Join Crying Map</div>
                <button class="close-btn" onclick="closeAuthModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Login Form -->
                <div id="loginForm">
                    <div class="form-group">
                        <div class="form-label">Email</div>
                        <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <div class="form-label">Password</div>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="submit-btn" onclick="handleLogin()">Sign In</button>
                    <button class="submit-btn" style="background: #4285f4; margin-top: 10px;" onclick="signInWithGoogle()">
                        📧 Sign in with Google
                    </button>
                    <div style="text-align: center; margin-top: 20px; color: #999;">
                        Don't have an account? <a href="#" style="color: #FF6B35;" onclick="showSignupForm()">Create one</a>
                    </div>
                </div>

                <!-- Signup Form -->
                <div id="signupForm" style="display: none;">
                    <div class="form-group">
                        <div class="form-label">Username</div>
                        <input type="text" class="form-input" id="signupUsername" placeholder="Choose a unique username">
                        <div id="usernameStatus" style="font-size: 12px; margin-top: 5px; color: #999;"></div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Email</div>
                        <input type="email" class="form-input" id="signupEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <div class="form-label">Password</div>
                        <input type="password" class="form-input" id="signupPassword" placeholder="Create a password">
                    </div>
                    <div class="form-group">
                        <div class="form-label">Confirm Password</div>
                        <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm your password">
                    </div>
                    <button class="submit-btn" onclick="handleSignup()">Create Account</button>
                    <button class="submit-btn" style="background: #4285f4; margin-top: 10px;" onclick="signInWithGoogle()">
                        📧 Sign up with Google
                    </button>
                    <div style="text-align: center; margin-top: 20px; color: #999;">
                        Already have an account? <a href="#" style="color: #FF6B35;" onclick="showLoginForm()">Sign in</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cry Modal -->
    <div class="modal" id="cryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">New cry</div>
                <button class="close-btn" onclick="closeCryModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Mini Map -->
                <div class="form-group">
                    <div class="form-label">Location</div>
                    <div class="mini-map" id="miniMap"></div>
                    <div style="text-align: center; color: #999; font-size: 12px; margin-top: 5px;">
                        Tap map to adjust pin location
                    </div>
                </div>

                <!-- Sticker Selection -->
                <div class="form-group">
                    <div class="form-label">Pick a sticker</div>
                    <div class="sticker-grid">
                        <button class="sticker-btn selected" data-emoji="😢" data-name="Crying" title="Regular tears from sadness, disappointment, or mild emotional pain" onclick="selectSticker(this)">😢</button>
                        <button class="sticker-btn" data-emoji="😭" data-name="Sobbing" title="Intense crying with loud sounds, overwhelming sadness or grief" onclick="selectSticker(this)">😭</button>
                        <button class="sticker-btn" data-emoji="💔" data-name="Heartbroken" title="When someone broke your heart, relationship pain, or deep emotional hurt" onclick="selectSticker(this)">💔</button>
                        <button class="sticker-btn" data-emoji="😂" data-name="Happy cry" title="Tears of joy, laughing so hard you cry, or overwhelming happiness" onclick="selectSticker(this)">😂</button>
                        <button class="sticker-btn" data-emoji="😰" data-name="Stressed" title="Anxious tears from pressure, worry, or feeling overwhelmed" onclick="selectSticker(this)">😰</button>
                        <button class="sticker-btn" data-emoji="🤧" data-name="Sick crying" title="When you're ill and emotional, or crying makes you need tissues" onclick="selectSticker(this)">🤧</button>
                        <button class="sticker-btn" data-emoji="🥲" data-name="Bittersweet" title="Mixed emotions - sad but accepting, nostalgic tears, or smiling through pain" onclick="selectSticker(this)">🥲</button>
                        <button class="sticker-btn" data-emoji="😤" data-name="Angry tears" title="Crying from frustration, rage, or when you're so mad you could cry" onclick="selectSticker(this)">😤</button>
                        <button class="sticker-btn" data-emoji="😪" data-name="Sleepy tears" title="Exhausted crying, too tired to handle emotions, or crying yourself to sleep" onclick="selectSticker(this)">😪</button>
                        <button class="sticker-btn" data-emoji="😩" data-name="Exhausted" title="Completely drained emotionally and physically, can't take anymore" onclick="selectSticker(this)">😩</button>
                        <button class="sticker-btn" data-emoji="🫠" data-name="Melting" title="Feeling like you're falling apart, overwhelming emotions dissolving you" onclick="selectSticker(this)">🫠</button>
                    </div>
                    <div class="sticker-description" id="stickerDescription">Regular tears from sadness, disappointment, or mild emotional pain</div>
                </div>

                <!-- Rating -->
                <div class="form-group">
                    <div class="form-label">Rate your cry</div>
                    <div class="rating-stars" id="cryRating">
                        <span class="star" onclick="setRating(1)">★</span>
                        <span class="star" onclick="setRating(2)">★</span>
                        <span class="star" onclick="setRating(3)">★</span>
                        <span class="star" onclick="setRating(4)">★</span>
                        <span class="star" onclick="setRating(5)">★</span>
                    </div>
                </div>

                <!-- Date & Time -->
                <div class="form-group">
                    <div class="form-label">Date & time</div>
                    <div style="background: #3d3d3d; padding: 12px; border-radius: 10px; color: #ccc; text-align: center;">
                        <span id="currentDateTime">Now • Loading...</span>
                    </div>
                </div>

                <!-- Location Tag -->
                <div class="form-group">
                    <div class="form-label">Tag location (optional)</div>
                    <input type="text" class="form-input" id="locationTag" placeholder="E.g. Home, Work, School...">
                </div>

                <!-- Description -->
                <div class="form-group">
                    <div class="form-label">Description (optional)</div>
                    <textarea class="form-input" id="cryDescription" placeholder="What made you cry?" rows="3"></textarea>
                </div>

                <button class="submit-btn" onclick="saveCry()">Save Cry</button>
            </div>
        </div>
    </div>

    <!-- Edit Cry Modal -->
    <div class="modal" id="editCryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit cry</div>
                <button class="close-btn" onclick="closeEditCryModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Date & Time Edit -->
                <div class="form-group">
                    <div class="form-label">Date & time</div>
                    <input type="datetime-local" class="datetime-input" id="editCryDateTime">
                </div>

                <!-- Mini Map -->
                <div class="form-group">
                    <div class="form-label">Location</div>
                    <div class="mini-map" id="editMiniMap"></div>
                    <div style="text-align: center; color: #999; font-size: 12px; margin-top: 5px;">
                        Tap map to adjust pin location
                    </div>
                </div>

                <!-- Rating Edit -->
                <div class="form-group">
                    <div class="form-label">Rating</div>
                    <div class="rating-stars" id="editCryRating">
                        <span class="star" onclick="setEditRating(1)">★</span>
                        <span class="star" onclick="setEditRating(2)">★</span>
                        <span class="star" onclick="setEditRating(3)">★</span>
                        <span class="star" onclick="setEditRating(4)">★</span>
                        <span class="star" onclick="setEditRating(5)">★</span>
                    </div>
                </div>

                <!-- Location Tag Edit -->
                <div class="form-group">
                    <div class="form-label">Tag location</div>
                    <input type="text" class="form-input" id="editLocationTag" placeholder="E.g. Home, Work, School...">
                </div>

                <!-- Description Edit -->
                <div class="form-group">
                    <div class="form-label">Description</div>
                    <textarea class="form-input" id="editCryDescription" placeholder="What made you cry?" rows="3"></textarea>
                </div>

                <button class="submit-btn" onclick="saveEditedCry()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Friends Modal -->
    <div class="modal" id="addFriendsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Friends</div>
                <button class="close-btn" onclick="closeAddFriendsModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div class="form-label">Search by username</div>
                    <input type="text" class="form-input" id="friendSearch" placeholder="Enter username" oninput="searchFriends()">
                </div>
                
                <div id="searchResults"></div>
            </div>
        </div>
    </div>

    <!-- Friends List Modal -->
    <div class="modal" id="friendsListModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="friendsListTitle">Following</div>
                <button class="close-btn" onclick="closeFriendsListModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="friendsListContent"></div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal" id="userProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="userProfileTitle">User Profile</div>
                <button class="close-btn" onclick="closeUserProfileModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="profile-header">
                    <div class="profile-avatar" id="userProfileAvatar">U</div>
                    <div class="profile-username" id="userProfileUsername">@username</div>
                    <div class="member-since" id="userProfileMemberSince">Member since</div>
                    <div class="profile-bio" id="userProfileBio"></div>
                    
                    <div class="profile-actions">
                        <button class="submit-btn" id="userProfileActionBtn" onclick="handleUserProfileAction()">
                            Add Friend
                        </button>
                        <button class="profile-btn" id="blockUserBtn" onclick="toggleBlockUser()" style="background: #ff4757;">
                            Block User
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-number" id="userProfileCries">0</span>
                        <span class="stat-label">Cries</span>
                    </div>
                    <div class="stat-item" onclick="showUserFollowing()" style="cursor: pointer;">
                        <span class="stat-number" id="userProfileFollowing">0</span>
                        <span class="stat-label">Following</span>
                    </div>
                    <div class="stat-item" onclick="showUserFollowers()" style="cursor: pointer;">
                        <span class="stat-number" id="userProfileFollowers">0</span>
                        <span class="stat-label">Followers</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="userProfileCountries">0</span>
                        <span class="stat-label">Countries</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit profile</div>
                <button class="close-btn" onclick="closeEditProfileModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="edit-option" onclick="changePhoto()">
                    <div class="edit-icon">📷</div>
                    <div>Change photo</div>
                </div>
                <div class="edit-option" onclick="changeName()">
                    <div class="edit-icon">👤</div>
                    <div>Name</div>
                </div>
                <div class="edit-option" onclick="changeEmail()">
                    <div class="edit-icon">📧</div>
                    <div>Email</div>
                </div>
                <div class="edit-option" onclick="changeUsername()">
                    <div class="edit-icon">🏷️</div>
                    <div>Username</div>
                </div>
                <div class="edit-option" onclick="changeBio()">
                    <div class="edit-icon">📝</div>
                    <div>Bio</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Settings Modal -->
    <div class="modal" id="privacySettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Privacy Settings</div>
                <button class="close-btn" onclick="closePrivacySettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <div class="setting-title">Private Profile</div>
                    <div class="toggle-switch" id="privateProfile" onclick="togglePrivacySetting('privateProfile')"></div>
                </div>
                <div style="padding: 0 20px; margin-bottom: 20px; color: #999; font-size: 14px;">
                    When enabled, only your friends can see your cries on the map and in the global feed.
                </div>
                <div class="setting-item">
                    <div class="setting-title">Approve followers</div>
                    <div class="toggle-switch" id="approveFollowers" onclick="togglePrivacySetting('approveFollowers')"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Share with followers</div>
                    <div class="toggle-switch" id="shareWithFollowers" onclick="togglePrivacySetting('shareWithFollowers')"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Share globally</div>
                    <div class="toggle-switch" id="shareGlobally" onclick="togglePrivacySetting('shareGlobally')"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Blocked Users Modal -->
    <div class="modal" id="blockedUsersModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Blocked Users</div>
                <button class="close-btn" onclick="closeBlockedUsers()">×</button>
            </div>
            <div class="modal-body">
                <div id="blockedUsersList">
                    <div class="empty-state">
                        <div class="empty-icon">🚫</div>
                        <h3>No blocked users</h3>
                        <p>You haven't blocked anyone yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div class="modal" id="notificationSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Notification Settings</div>
                <button class="close-btn" onclick="closeNotificationSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <div class="setting-title">New cries</div>
                    <div class="toggle-switch" id="notifyNewCries" onclick="toggleSetting('notifyNewCries')"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">New followers</div>
                    <div class="toggle-switch" id="notifyNewFollowers" onclick="toggleSetting('notifyNewFollowers')"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Comments</div>
                    <div class="toggle-switch" id="notifyComments" onclick="toggleSetting('notifyComments')"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Likes</div>
                    <div class="toggle-switch" id="notifyLikes" onclick="toggleSetting('notifyLikes')"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feed Settings Modal -->
    <div class="modal" id="feedSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Feed Settings</div>
                <button class="close-btn" onclick="closeFeedSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <div class="setting-title">Show photos</div>
                    <div class="toggle-switch" id="showPhotos" onclick="toggleSetting('showPhotos')"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Show selfies</div>
                    <div class="toggle-switch" id="showSelfies" onclick="toggleSetting('showSelfies')"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Show map photos</div>
                    <div class="toggle-switch" id="showMapPhotos" onclick="toggleSetting('showMapPhotos')"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal" id="statisticsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Statistics</div>
                <button class="close-btn" onclick="closeStatisticsModal()">×</button>
            </div>
            <div class="modal-body">
                <div style="background: #2d2d2d; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Your Crying Journey</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Start date:</span>
                        <span id="statsStartDate">Not started</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Days active:</span>
                        <span id="statsDaysActive">0 days</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Countries visited:</span>
                        <span id="statsCountriesVisited">0 countries</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Total likes received:</span>
                        <span id="statsTotalLikes">0 likes</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Total comments:</span>
                        <span id="statsTotalComments">0 comments</span>
                    </div>
                </div>
                
                <button class="submit-btn" style="background: #ff4757;" onclick="resetStatistics()">
                    Reset All Statistics
                </button>
                
                <p style="text-align: center; color: #999; font-size: 12px; margin-top: 15px;">
                    This will permanently delete all your cries and reset your statistics. This action cannot be undone.
                </p>
            </div>
        </div>
    </div>

    <!-- Cries Modal -->
    <div class="modal" id="criesModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Your Cries</div>
                <button class="close-btn" onclick="closeCriesModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Cries Tabs -->
                <div class="profile-tabs" style="margin-top: 0;">
                    <button class="profile-tab active" onclick="switchCriesTab('history')">History</button>
                    <button class="profile-tab" onclick="switchCriesTab('search')">Search</button>
                </div>

                <!-- History Tab -->
                <div class="tab-content active" id="criesHistoryTab">
                    <div class="history-container" id="modalHistoryContainer"></div>
                </div>

                <!-- Search Tab -->
                <div class="tab-content" id="criesSearchTab">
                    <div class="search-container">
                        <input type="text" class="search-input" id="modalCrySearchInput" placeholder="Search your cries..." oninput="searchCriesModal()">
                        <div class="search-filters">
                            <button class="search-filter-btn active" data-filter="all" onclick="setSearchFilter('all'); searchCriesModal()">All</button>
                            <button class="search-filter-btn" data-filter="happy" onclick="setSearchFilter('happy'); searchCriesModal()">Happy</button>
                            <button class="search-filter-btn" data-filter="sad" onclick="setSearchFilter('sad'); searchCriesModal()">Sad</button>
                            <button class="search-filter-btn" data-filter="angry" onclick="setSearchFilter('angry'); searchCriesModal()">Angry</button>
                            <button class="search-filter-btn" data-filter="stressed" onclick="setSearchFilter('stressed'); searchCriesModal()">Stressed</button>
                        </div>
                    </div>
                    <div id="modalSearchResults"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div class="modal" id="calendarModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Your Cry Calendar</div>
                <button class="close-btn" onclick="closeCalendarModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="calendar-container" style="margin: 0;">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="changeMonth(-1)">◀</button>
                        <h3 id="calendarMonth">January 2025</h3>
                        <button class="calendar-nav-btn" onclick="changeMonth(1)">▶</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievement Details Modal -->
    <div class="modal" id="achievementDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="achievementDetailsTitle">Achievement</div>
                <button class="close-btn" onclick="closeAchievementDetails()">×</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div class="achievement-icon" id="achievementDetailsIcon" style="font-size: 64px; margin: 20px 0;">🏆</div>
                <h3 id="achievementDetailsName">Achievement Name</h3>
                <p id="achievementDetailsDescription" style="color: #999; margin: 15px 0;">Description</p>
                <div id="achievementDetailsProgress" style="margin: 20px 0;">
                    <div class="achievement-progress-bar" style="height: 8px; margin: 10px auto; max-width: 200px;">
                        <div class="achievement-progress-fill" id="achievementDetailsFill" style="width: 0%;"></div>
                    </div>
                    <p style="color: #FF6B35;" id="achievementDetailsStatus">0/10</p>
                </div>
                <p id="achievementDetailsUnlocked" style="color: #4CAF50; display: none;">✅ Unlocked on <span id="unlockedDate"></span></p>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let map, miniMap, miniMapMarker, editMiniMap, editMiniMapMarker;
        let currentUser = null;
        let isLoggedIn = false;
        let userLocation = null;
        let selectedCry = { emoji: '😢', name: 'Crying', rating: 0 };
        let currentFilter = 'global';
        let currentPage = 'mapPage';
        let currentCriesTab = 'history';
        let currentSearchFilter = 'all';
        let cries = JSON.parse(localStorage.getItem('cries') || '[]');
        let friends = [];
        let followers = [];
        let following = [];
        let friendRequests = [];
        let blockedUsers = JSON.parse(localStorage.getItem('blockedUsers') || '[]');
        let mapMarkers = [];
        let searchTimeout = null;
        let usernameCheckTimeout = null;
        let currentViewingUserId = null;
        let currentViewingCry = null;
        let currentEditingCry = null;
        let currentCalendarDate = new Date();
        let achievements = {};
        let userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');

        // Achievement Definitions
        const achievementDefinitions = {
            firstCry: { icon: '🎯', name: 'First Cry', description: 'Place your first cry on the map', target: 1 },
            fiveCries: { icon: '🌟', name: 'Emotional Explorer', description: 'Place 5 cries', target: 5 },
            tenCries: { icon: '💫', name: 'Tear Tracker', description: 'Place 10 cries', target: 10 },
            twentyFiveCries: { icon: '🌊', name: 'Cry Baby', description: 'Place 25 cries', target: 25 },
            fiftyCries: { icon: '🌈', name: 'Emotional Master', description: 'Place 50 cries', target: 50 },
            weekStreak: { icon: '🔥', name: 'Week Streak', description: 'Cry every day for a week', target: 7 },
            nightOwl: { icon: '🦉', name: 'Night Owl', description: 'Cry after midnight', target: 1 },
            earlyBird: { icon: '🐦', name: 'Early Bird', description: 'Cry before 6 AM', target: 1 },
            socialButterfly: { icon: '🦋', name: 'Social Butterfly', description: 'Get 10 friends', target: 10 },
            worldTraveler: { icon: '🌍', name: 'World Traveler', description: 'Cry in 5 different countries', target: 5 },
            popularCry: { icon: '❤️', name: 'Popular Cry', description: 'Get 10 likes on a single cry', target: 10 },
            commentator: { icon: '💬', name: 'Commentator', description: 'Leave 20 comments', target: 20 }
        };

        // Enhanced Country Detection with more countries
        const countryBounds = {
            'Denmark': { north: 57.8, south: 54.5, east: 15.2, west: 8.0 },
            'Germany': { north: 55.1, south: 47.3, east: 15.0, west: 5.9 },
            'Sweden': { north: 69.1, south: 55.3, east: 24.2, west: 11.0 },
            'Norway': { north: 71.2, south: 57.9, east: 31.2, west: 4.5 },
            'United States': { north: 49.4, south: 24.5, east: -66.9, west: -125.0 },
            'United Kingdom': { north: 60.9, south: 49.9, east: 1.8, west: -8.6 },
            'France': { north: 51.1, south: 41.3, east: 9.6, west: -5.1 },
            'Spain': { north: 43.8, south: 36.0, east: 4.3, west: -9.3 },
            'Italy': { north: 47.1, south: 36.6, east: 18.5, west: 6.6 },
            'Netherlands': { north: 53.5, south: 50.8, east: 7.2, west: 3.4 },
            'Belgium': { north: 51.5, south: 49.5, east: 6.4, west: 2.5 },
            'Switzerland': { north: 47.8, south: 45.8, east: 10.5, west: 5.9 },
            'Austria': { north: 49.0, south: 46.4, east: 17.2, west: 9.5 },
            'Poland': { north: 54.8, south: 49.0, east: 24.1, west: 14.1 },
            'Czech Republic': { north: 51.1, south: 48.6, east: 18.9, west: 12.1 },
            'Portugal': { north: 42.2, south: 36.9, east: -6.2, west: -9.5 },
            'Greece': { north: 41.7, south: 34.8, east: 28.2, west: 19.4 },
            'Finland': { north: 70.1, south: 59.8, east: 31.6, west: 20.5 },
            'Ireland': { north: 55.4, south: 51.4, east: -5.9, west: -10.5 },
            'Canada': { north: 83.1, south: 41.7, east: -52.6, west: -141.0 },
            'Mexico': { north: 32.7, south: 14.5, east: -86.7, west: -118.4 },
            'Brazil': { north: 5.3, south: -33.8, east: -34.8, west: -73.9 },
            'Argentina': { north: -21.8, south: -55.1, east: -53.6, west: -73.6 },
            'Australia': { north: -10.0, south: -39.2, east: 153.6, west: 112.9 },
            'New Zealand': { north: -34.4, south: -47.3, east: 178.6, west: 166.4 },
            'Japan': { north: 45.5, south: 24.4, east: 145.8, west: 122.9 },
            'China': { north: 53.6, south: 18.2, east: 134.8, west: 73.5 },
            'India': { north: 35.5, south: 8.1, east: 97.4, west: 68.2 },
            'Russia': { north: 81.9, south: 41.2, east: 180.0, west: 19.6 },
            'South Africa': { north: -22.1, south: -34.8, east: 32.9, west: 16.5 }
        };

        // Initialize App
        window.initializeApp = function() {
            console.log('🚀 Initializing Crying Map Complete Edition...');
            
            // Load settings
            loadSettings();
            
            // Load achievements
            loadAchievements();
            
            // Update UI
            updateDateTime();
            updatePageHeader();
            
            // Request location
            requestLocation();
            
            // Setup auth listener
            setupAuthListener();
            
            // Setup username check
            setupUsernameCheck();
            
            console.log('✅ App initialized');
        };

        // Settings Management
        function loadSettings() {
            // Load privacy settings
            const privacySettings = JSON.parse(localStorage.getItem('privacySettings') || '{}');
            if (privacySettings.privateProfile) document.getElementById('privateProfile')?.classList.add('active');
            if (privacySettings.approveFollowers) document.getElementById('approveFollowers')?.classList.add('active');
            if (privacySettings.shareWithFollowers) document.getElementById('shareWithFollowers')?.classList.add('active');
            if (privacySettings.shareGlobally) document.getElementById('shareGlobally')?.classList.add('active');
            
            // Load notification settings  
            const notificationSettings = JSON.parse(localStorage.getItem('notificationSettings') || '{}');
            if (notificationSettings.notifyNewCries) document.getElementById('notifyNewCries')?.classList.add('active');
            if (notificationSettings.notifyNewFollowers) document.getElementById('notifyNewFollowers')?.classList.add('active');
            if (notificationSettings.notifyComments) document.getElementById('notifyComments')?.classList.add('active');
            if (notificationSettings.notifyLikes) document.getElementById('notifyLikes')?.classList.add('active');
            
            // Load feed settings
            const feedSettings = JSON.parse(localStorage.getItem('feedSettings') || '{}');
            if (feedSettings.showPhotos) document.getElementById('showPhotos')?.classList.add('active');
            if (feedSettings.showSelfies) document.getElementById('showSelfies')?.classList.add('active');
            if (feedSettings.showMapPhotos) document.getElementById('showMapPhotos')?.classList.add('active');
        }

        // Toggle Settings
        window.toggleSetting = function(settingId) {
            const toggle = document.getElementById(settingId);
            toggle.classList.toggle('active');
            
            // Save to localStorage
            const settingType = settingId.includes('notify') ? 'notificationSettings' : 
                               settingId.includes('show') ? 'feedSettings' : 'privacySettings';
            
            const settings = JSON.parse(localStorage.getItem(settingType) || '{}');
            settings[settingId] = toggle.classList.contains('active');
            localStorage.setItem(settingType, JSON.stringify(settings));
        };

        window.togglePrivacySetting = function(settingId) {
            const toggle = document.getElementById(settingId);
            toggle.classList.toggle('active');
            
            const settings = JSON.parse(localStorage.getItem('privacySettings') || '{}');
            settings[settingId] = toggle.classList.contains('active');
            localStorage.setItem('privacySettings', JSON.stringify(settings));
            
            // Apply privacy changes immediately
            if (settingId === 'privateProfile') {
                applyFilter(); // Re-apply current filter with new privacy settings
            }
        };

        // Google Maps Callback
        window.initMap = function() {
            const center = userLocation || { lat: 55.6761, lng: 12.5683 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: center,
                styles: getMapStyles(),
                disableDefaultUI: true,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_CENTER
                }
            });
            
            // Add click listener
            map.addListener('click', function(event) {
                openCryModal(event.latLng);
            });
            
            // Load cries
            loadCriesOnMap();
            
            if (userLocation) {
                addUserLocationMarker();
            }
        };

        // Map Styles
        function getMapStyles() {
            return [
                { elementType: 'geometry', stylers: [{ color: '#212121' }] },
                { elementType: 'labels.text.fill', stylers: [{ color: '#757575' }] },
                { elementType: 'labels.text.stroke', stylers: [{ color: '#212121' }] },
                { featureType: 'road', elementType: 'geometry.fill', stylers: [{ color: '#2c2c2c' }] },
                { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#000000' }] },
                { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] },
                { featureType: 'transit', elementType: 'labels', stylers: [{ visibility: 'off' }] }
            ];
        }

        // Navigation
        window.switchPage = function(pageId) {
            // Update active states
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            // Activate new page
            document.getElementById(pageId).classList.add('active');
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            currentPage = pageId;
            updatePageHeader();
            
            // Page-specific logic
            if (pageId === 'feedPage') loadFeed();
            if (pageId === 'profilePage') {
                updateProfileStats();
                updateAchievements();
            }
            if (pageId === 'notificationsPage') loadNotifications();
        };

        // Cries Modal Functions
        window.openCriesModal = function() {
            // Allow both logged in and guest users to view their cries
            document.getElementById('criesModal').classList.add('active');
            if (currentCriesTab === 'history') {
                loadModalHistory();
            } else {
                searchCriesModal();
            }
        };

        window.closeCriesModal = function() {
            document.getElementById('criesModal').classList.remove('active');
        };

        window.switchCriesTab = function(tab) {
            currentCriesTab = tab;
            
            // Update tab buttons
            const tabs = document.querySelectorAll('#criesModal .profile-tab');
            tabs.forEach(t => t.classList.remove('active'));
            tabs[tab === 'history' ? 0 : 1].classList.add('active');
            
            // Update tab content
            document.getElementById('criesHistoryTab').classList.toggle('active', tab === 'history');
            document.getElementById('criesSearchTab').classList.toggle('active', tab === 'search');
            
            // Load tab content
            if (tab === 'history') loadModalHistory();
            if (tab === 'search') searchCriesModal();
        };

        // Calendar Modal Functions
        window.openCalendarModal = function() {
            // Allow both logged in and guest users to view their calendar
            document.getElementById('calendarModal').classList.add('active');
            updateCalendar();
        };

        window.closeCalendarModal = function() {
            document.getElementById('calendarModal').classList.remove('active');
        };

        // Page Header
        function updatePageHeader() {
            const headerTitle = document.getElementById('headerTitle');
            const headerAction = document.getElementById('headerAction');
            const calendarBtn = document.getElementById('calendarBtn');
            
            // Hide both buttons by default
            headerAction.style.display = 'none';
            calendarBtn.style.display = 'none';
            
            switch(currentPage) {
                case 'mapPage':
                    headerTitle.textContent = 'Map';
                    break;
                case 'feedPage':
                    headerTitle.textContent = 'Feed';
                    headerAction.textContent = 'Add Friends';
                    headerAction.style.display = isLoggedIn ? 'block' : 'none';
                    headerAction.style.background = '#FF6B35';
                    break;
                case 'profilePage':
                    headerTitle.textContent = 'Profile';
                    calendarBtn.style.display = 'block'; // Show calendar button for all users
                    break;
                case 'notificationsPage':
                    headerTitle.textContent = 'Inbox';
                    break;
                case 'settingsPage':
                    headerTitle.textContent = 'Settings';
                    if (isLoggedIn) {
                        headerAction.textContent = 'Logout';
                        headerAction.style.display = 'block';
                        headerAction.style.background = '#ff4757';
                    }
                    break;
            }
        }

        // Header Action
        window.handleHeaderAction = function() {
            switch(currentPage) {
                case 'feedPage':
                    if (isLoggedIn) openAddFriendsModal();
                    break;
                case 'settingsPage':
                    if (isLoggedIn && confirm('Are you sure you want to logout?')) {
                        handleLogout();
                    }
                    break;
            }
        };

        // Authentication
        function setupAuthListener() {
            if (window.onAuthStateChanged && window.auth) {
                window.onAuthStateChanged(window.auth, async (user) => {
                    currentUser = user;
                    isLoggedIn = !!user;
                    
                    if (user) {
                        await loadUserProfile();
                        await loadFriendsAndNotifications();
                    }
                    
                    updateUI();
                });
            } else {
                setTimeout(setupAuthListener, 500);
            }
        }

        async function loadUserProfile() {
            if (!currentUser || !window.db) return;

            try {
                const userDoc = await window.getDoc(window.doc(window.db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    currentUser.profileData = userDoc.data();
                    updateProfileInfo();
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        window.showAuthModal = function() {
            document.getElementById('authModal').classList.add('active');
        };

        window.closeAuthModal = function() {
            document.getElementById('authModal').classList.remove('active');
        };

        window.showLoginForm = function() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
        };

        window.showSignupForm = function() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
        };

        window.handleLogin = async function() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            try {
                await window.signInWithEmailAndPassword(window.auth, email, password);
                closeAuthModal();
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        };

        window.handleSignup = async function() {
            const username = document.getElementById('signupUsername').value.trim().toLowerCase();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!username || !email || !password || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }

            if (username.length < 3) {
                alert('Username must be at least 3 characters long');
                return;
            }

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            try {
                // Check username availability
                const isAvailable = await checkUsernameAvailability(username);
                if (!isAvailable) {
                    alert('Username is already taken');
                    return;
                }

                // Create account
                const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);
                
                // Save profile
                await window.setDoc(window.doc(window.db, 'users', userCredential.user.uid), {
                    uid: userCredential.user.uid,
                    username: username,
                    email: email,
                    displayName: username,
                    bio: '',
                    createdAt: new Date(),
                    stats: {
                        cries: 0,
                        following: 0,
                        followers: 0,
                        countries: 0,
                        avgRating: 0,
                        totalLikes: 0,
                        totalComments: 0
                    },
                    achievements: {},
                    privacySettings: {}
                });
                
                closeAuthModal();
            } catch (error) {
                alert('Signup failed: ' + error.message);
            }
        };

        window.signInWithGoogle = async function() {
            try {
                const result = await window.signInWithPopup(window.auth, window.googleProvider);
                
                // Check if profile exists
                const userDoc = await window.getDoc(window.doc(window.db, 'users', result.user.uid));
                
                if (!userDoc.exists()) {
                    // Create profile for new Google user
                    const baseUsername = result.user.displayName?.toLowerCase().replace(/\s+/g, '') || 
                                       result.user.email.split('@')[0];
                    let username = baseUsername;
                    let counter = 1;
                    
                    while (!(await checkUsernameAvailability(username))) {
                        username = baseUsername + counter;
                        counter++;
                    }
                    
                    await window.setDoc(window.doc(window.db, 'users', result.user.uid), {
                        uid: result.user.uid,
                        username: username,
                        email: result.user.email,
                        displayName: result.user.displayName || username,
                        bio: '',
                        createdAt: new Date(),
                        stats: {
                            cries: 0,
                            following: 0,
                            followers: 0,
                            countries: 0,
                            avgRating: 0,
                            totalLikes: 0,
                            totalComments: 0
                        },
                        achievements: {},
                        privacySettings: {}
                    });
                }
                
                closeAuthModal();
            } catch (error) {
                alert('Google sign-in failed: ' + error.message);
            }
        };

        window.handleLogout = async function() {
            try {
                await window.signOut(window.auth);
                currentUser = null;
                isLoggedIn = false;
                friends = [];
                followers = [];
                following = [];
                friendRequests = [];
                updateUI();
                switchPage('mapPage');
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // Username Validation
        function setupUsernameCheck() {
            const usernameInput = document.getElementById('signupUsername');
            if (!usernameInput) return;
            
            usernameInput.addEventListener('input', function() {
                clearTimeout(usernameCheckTimeout);
                const username = this.value.trim().toLowerCase();
                const statusDiv = document.getElementById('usernameStatus');
                
                if (username.length < 3) {
                    statusDiv.textContent = 'Username must be at least 3 characters';
                    statusDiv.style.color = '#ff6b35';
                    return;
                }
                
                statusDiv.textContent = 'Checking availability...';
                statusDiv.style.color = '#999';
                
                usernameCheckTimeout = setTimeout(async () => {
                    const isAvailable = await checkUsernameAvailability(username);
                    if (isAvailable) {
                        statusDiv.textContent = '✅ Username available!';
                        statusDiv.style.color = '#4CAF50';
                    } else {
                        statusDiv.textContent = '❌ Username taken';
                        statusDiv.style.color = '#ff6b35';
                    }
                }, 500);
            });
        }

        async function checkUsernameAvailability(username) {
            try {
                const q = window.query(window.collection(window.db, 'users'), window.where('username', '==', username));
                const snapshot = await window.getDocs(q);
                return snapshot.empty;
            } catch (error) {
                console.error('Username check error:', error);
                return false;
            }
        }

        // Cry Modal
        window.openCryModal = function(location = null) {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            selectedCry = { emoji: '😢', name: 'Crying', rating: 0 };
            document.getElementById('cryModal').classList.add('active');
            updateDateTime();
            
            // Reset rating display
            document.querySelectorAll('#cryRating .star').forEach(star => star.classList.remove('filled'));
            
            setTimeout(() => {
                initMiniMap(location);
            }, 100);
        };

        window.closeCryModal = function() {
            document.getElementById('cryModal').classList.remove('active');
            resetCryForm();
        };

        window.selectSticker = function(button) {
            document.querySelectorAll('.sticker-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedCry.emoji = button.dataset.emoji;
            selectedCry.name = button.dataset.name;
            
            // Update description on mobile
            const description = document.getElementById('stickerDescription');
            if (description) {
                description.textContent = button.getAttribute('title');
            }
            
            // Update mini map marker
            if (miniMapMarker) {
                miniMapMarker.setIcon(createCryIcon(selectedCry.emoji));
            }
        };

        window.setRating = function(rating) {
            selectedCry.rating = rating;
            updateRatingDisplay('cryRating', rating);
        };

        function updateRatingDisplay(containerId, rating) {
            const stars = document.querySelectorAll(`#${containerId} .star`);
            stars.forEach((star, index) => {
                star.classList.toggle('filled', index < rating);
            });
        }

        window.saveCry = async function() {
            const locationTag = document.getElementById('locationTag').value;
            const description = document.getElementById('cryDescription').value;
            
            if (selectedCry.rating === 0) {
                alert('Please rate your cry');
                return;
            }
            
            let position = userLocation || { lat: 55.6761, lng: 12.5683 };
            if (miniMapMarker) {
                const markerPos = miniMapMarker.getPosition();
                position = {
                    lat: markerPos.lat(),
                    lng: markerPos.lng()
                };
            }
            
            // Detect country
            const country = detectCountry(position.lat, position.lng);
            
            const cry = {
                id: Date.now().toString(),
                emoji: selectedCry.emoji,
                name: selectedCry.name,
                rating: selectedCry.rating,
                locationTag: locationTag,
                description: description,
                lat: position.lat,
                lng: position.lng,
                country: country,
                timestamp: new Date(),
                userId: currentUser?.uid || 'anonymous',
                userEmail: currentUser?.email || null,
                username: currentUser?.profileData?.username || 'Anonymous',
                likes: [],
                comments: []
            };
            
            // Save locally
            cries.unshift(cry);
            localStorage.setItem('cries', JSON.stringify(cries));
            
            // Save to Firebase if logged in
            if (isLoggedIn && window.db) {
                try {
                    await window.setDoc(window.doc(window.db, 'cries', cry.id), cry);
                    
                    // Update user stats
                    await updateUserStats();
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                }
            }
            
            // Add to map
            addCryMarker(cry);
            
            // Check achievements
            checkAchievements();
            
            // Update stats
            updateProfileStats();
            
            // Refresh cries modal if it was open
            if (document.getElementById('criesModal').classList.contains('active')) {
                if (currentCriesTab === 'history') {
                    loadModalHistory();
                } else {
                    searchCriesModal();
                }
            }
            
            closeCryModal();
        };

        async function updateUserStats() {
            if (!isLoggedIn || !window.db) return;
            
            try {
                const userCries = cries.filter(cry => cry.userId === currentUser.uid);
                const countries = new Set(userCries.map(cry => cry.country).filter(c => c && c !== 'Unknown'));
                const totalRating = userCries.reduce((sum, cry) => sum + (cry.rating || 0), 0);
                const avgRating = userCries.length > 0 ? (totalRating / userCries.length).toFixed(2) : 0;
                
                await window.updateDoc(window.doc(window.db, 'users', currentUser.uid), {
                    'stats.cries': userCries.length,
                    'stats.countries': countries.size,
                    'stats.avgRating': parseFloat(avgRating)
                });
            } catch (error) {
                console.error('Error updating user stats:', error);
            }
        }

        function detectCountry(lat, lng) {
            for (const [country, bounds] of Object.entries(countryBounds)) {
                if (lat >= bounds.south && lat <= bounds.north && 
                    lng >= bounds.west && lng <= bounds.east) {
                    return country;
                }
            }
            return 'Unknown';
        }

        function initMiniMap(location) {
            const mapCenter = location || userLocation || { lat: 55.6761, lng: 12.5683 };
            
            miniMap = new google.maps.Map(document.getElementById('miniMap'), {
                zoom: 16,
                center: mapCenter,
                styles: getMapStyles(),
                disableDefaultUI: true
            });
            
            miniMapMarker = new google.maps.Marker({
                position: mapCenter,
                map: miniMap,
                draggable: true,
                icon: createCryIcon(selectedCry.emoji)
            });
            
            miniMap.addListener('click', function(event) {
                miniMapMarker.setPosition(event.latLng);
            });
        }

        function createCryIcon(emoji) {
            return {
                url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                    <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="18" fill="white" stroke="#FF6B35" stroke-width="3"/>
                        <text x="20" y="28" font-size="16" text-anchor="middle">${emoji}</text>
                    </svg>
                `)}`,
                scaledSize: new google.maps.Size(40, 40)
            };
        }

        function resetCryForm() {
            document.getElementById('locationTag').value = '';
            document.getElementById('cryDescription').value = '';
            document.querySelectorAll('.sticker-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector('.sticker-btn').classList.add('selected');
            selectedCry = { emoji: '😢', name: 'Crying', rating: 0 };
            document.querySelectorAll('#cryRating .star').forEach(star => star.classList.remove('filled'));
        }

        // Map Functions
        function loadCriesOnMap() {
            cries.forEach(cry => addCryMarker(cry));
        }

        function addCryMarker(cry) {
            if (!map) return;
            
            const marker = new google.maps.Marker({
                position: { lat: cry.lat, lng: cry.lng },
                map: map,
                title: `${cry.name} - ${cry.timestamp}`,
                icon: createCryIcon(cry.emoji),
                animation: google.maps.Animation.DROP
            });
            
            marker.addListener('click', function() {
                showCryInfo(cry);
            });
            
            marker.cryData = cry;
            mapMarkers.push(marker);
            
            applyFilter();
        }

        function showCryInfo(cry) {
            currentViewingCry = cry;
            
            // Update cry info modal
            document.getElementById('cryInfoEmoji').textContent = cry.emoji;
            document.getElementById('cryInfoName').textContent = cry.name;
            document.getElementById('cryInfoUser').textContent = `by @${cry.username || 'Anonymous'}`;
            document.getElementById('cryInfoLocation').textContent = cry.locationTag || cry.country || 'Unknown location';
            document.getElementById('cryInfoTime').textContent = new Date(cry.timestamp).toLocaleString();
            document.getElementById('cryInfoDescription').textContent = cry.description || '';
            document.getElementById('cryInfoDescription').style.display = cry.description ? 'block' : 'none';
            
            // Update rating display
            updateRatingDisplay('cryInfoRating', cry.rating || 0);
            
            // Update like button
            const isLiked = userLikes[cry.id] === true;
            const likeCount = cry.likes?.length || 0;
            document.getElementById('likeIcon').textContent = isLiked ? '❤️' : '🤍';
            document.getElementById('likeCount').textContent = likeCount;
            document.getElementById('likeCryBtn').classList.toggle('active', isLiked);
            
            // Update comment count
            document.getElementById('commentCount').textContent = cry.comments?.length || 0;
            
            // Show/hide edit and delete buttons
            const isOwner = isLoggedIn && cry.userId === currentUser?.uid;
            document.getElementById('editCryBtn').style.display = isOwner ? 'flex' : 'none';
            document.getElementById('deleteCryBtn').style.display = isOwner ? 'flex' : 'none';
            
            // Load comments
            loadComments();
            
            // Show modal
            document.getElementById('cryInfoModal').classList.add('active');
        }

        window.closeCryInfo = function() {
            document.getElementById('cryInfoModal').classList.remove('active');
            document.getElementById('commentSection').style.display = 'none';
            currentViewingCry = null;
        };

        window.toggleLikeCry = async function() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            if (!currentViewingCry) return;
            
            const cryId = currentViewingCry.id;
            const isLiked = userLikes[cryId] === true;
            
            // Update local state
            userLikes[cryId] = !isLiked;
            localStorage.setItem('userLikes', JSON.stringify(userLikes));
            
            // Update cry data
            const cryIndex = cries.findIndex(c => c.id === cryId);
            if (cryIndex !== -1) {
                if (!cries[cryIndex].likes) cries[cryIndex].likes = [];
                
                if (isLiked) {
                    // Unlike
                    cries[cryIndex].likes = cries[cryIndex].likes.filter(uid => uid !== currentUser.uid);
                } else {
                    // Like
                    cries[cryIndex].likes.push(currentUser.uid);
                }
                
                localStorage.setItem('cries', JSON.stringify(cries));
                
                // Update UI
                const likeCount = cries[cryIndex].likes.length;
                document.getElementById('likeIcon').textContent = !isLiked ? '❤️' : '🤍';
                document.getElementById('likeCount').textContent = likeCount;
                document.getElementById('likeCryBtn').classList.toggle('active', !isLiked);
                
                // Update Firebase
                if (window.db) {
                    try {
                        await window.updateDoc(window.doc(window.db, 'cries', cryId), {
                            likes: cries[cryIndex].likes
                        });
                    } catch (error) {
                        console.error('Error updating likes:', error);
                    }
                }
                
                // Check achievement
                if (cries[cryIndex].likes.length >= 10) {
                    unlockAchievement('popularCry');
                }
            }
        };

        window.toggleComments = function() {
            const commentSection = document.getElementById('commentSection');
            commentSection.style.display = commentSection.style.display === 'none' ? 'block' : 'none';
            
            if (commentSection.style.display === 'block') {
                document.getElementById('commentInput').focus();
            }
        };

        window.addComment = async function() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            const commentInput = document.getElementById('commentInput');
            const commentText = commentInput.value.trim();
            
            if (!commentText || !currentViewingCry) return;
            
            const comment = {
                id: Date.now().toString(),
                text: commentText,
                userId: currentUser.uid,
                username: currentUser.profileData?.username || 'Anonymous',
                timestamp: new Date()
            };
            
            // Update local data
            const cryIndex = cries.findIndex(c => c.id === currentViewingCry.id);
            if (cryIndex !== -1) {
                if (!cries[cryIndex].comments) cries[cryIndex].comments = [];
                cries[cryIndex].comments.push(comment);
                localStorage.setItem('cries', JSON.stringify(cries));
                
                // Update UI
                commentInput.value = '';
                loadComments();
                document.getElementById('commentCount').textContent = cries[cryIndex].comments.length;
                
                // Update Firebase
                if (window.db) {
                    try {
                        await window.updateDoc(window.doc(window.db, 'cries', currentViewingCry.id), {
                            comments: cries[cryIndex].comments
                        });
                        
                        // Update user comment count
                        await window.updateDoc(window.doc(window.db, 'users', currentUser.uid), {
                            'stats.totalComments': window.increment(1)
                        });
                    } catch (error) {
                        console.error('Error adding comment:', error);
                    }
                }
                
                // Check achievement
                checkCommentAchievement();
            }
        };

        function loadComments() {
            if (!currentViewingCry) return;
            
            const commentsList = document.getElementById('commentsList');
            const comments = currentViewingCry.comments || [];
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<p style="text-align: center; color: #999; font-size: 14px;">No comments yet. Be the first!</p>';
                return;
            }
            
            commentsList.innerHTML = comments.map(comment => {
                const isOwner = isLoggedIn && (comment.userId === currentUser?.uid || currentViewingCry.userId === currentUser?.uid);
                return `
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author" onclick="showUserProfile('${comment.userId}')" style="cursor: pointer;">@${comment.username}</span>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="comment-time">${getTimeAgo(new Date(comment.timestamp))}</span>
                                ${isOwner ? `<button class="delete-comment-btn" onclick="deleteComment('${comment.id}')">Delete</button>` : ''}
                            </div>
                        </div>
                        <div class="comment-text">${comment.text}</div>
                    </div>
                `;
            }).join('');
        }

        window.deleteComment = async function(commentId) {
            if (!currentViewingCry || !confirm('Delete this comment?')) return;
            
            const cryIndex = cries.findIndex(c => c.id === currentViewingCry.id);
            if (cryIndex !== -1) {
                cries[cryIndex].comments = cries[cryIndex].comments.filter(c => c.id !== commentId);
                localStorage.setItem('cries', JSON.stringify(cries));
                
                // Update UI
                loadComments();
                document.getElementById('commentCount').textContent = cries[cryIndex].comments.length;
                
                // Update Firebase
                if (window.db) {
                    try {
                        await window.updateDoc(window.doc(window.db, 'cries', currentViewingCry.id), {
                            comments: cries[cryIndex].comments
                        });
                    } catch (error) {
                        console.error('Error deleting comment:', error);
                    }
                }
            }
        };

        window.editCry = function() {
            if (!currentViewingCry) return;
            
            currentEditingCry = currentViewingCry;
            
            // Set edit form values
            const dateTime = new Date(currentViewingCry.timestamp);
            document.getElementById('editCryDateTime').value = dateTime.toISOString().slice(0, 16);
            document.getElementById('editLocationTag').value = currentViewingCry.locationTag || '';
            document.getElementById('editCryDescription').value = currentViewingCry.description || '';
            
            // Set rating
            updateRatingDisplay('editCryRating', currentViewingCry.rating || 0);
            
            // Close info modal and open edit modal
            closeCryInfo();
            document.getElementById('editCryModal').classList.add('active');
            
            // Initialize edit map
            setTimeout(() => {
                initEditMiniMap({ lat: currentViewingCry.lat, lng: currentViewingCry.lng });
            }, 100);
        };

        function initEditMiniMap(position) {
            editMiniMap = new google.maps.Map(document.getElementById('editMiniMap'), {
                zoom: 16,
                center: position,
                styles: getMapStyles(),
                disableDefaultUI: true
            });
            
            editMiniMapMarker = new google.maps.Marker({
                position: position,
                map: editMiniMap,
                draggable: true,
                icon: createCryIcon(currentEditingCry.emoji)
            });
            
            editMiniMap.addListener('click', function(event) {
                editMiniMapMarker.setPosition(event.latLng);
            });
        }

        window.setEditRating = function(rating) {
            if (currentEditingCry) {
                currentEditingCry.rating = rating;
                updateRatingDisplay('editCryRating', rating);
            }
        };

        window.saveEditedCry = async function() {
            if (!currentEditingCry) return;
            
            // Get updated values
            const dateTime = new Date(document.getElementById('editCryDateTime').value);
            const locationTag = document.getElementById('editLocationTag').value;
            const description = document.getElementById('editCryDescription').value;
            
            let position = { lat: currentEditingCry.lat, lng: currentEditingCry.lng };
            if (editMiniMapMarker) {
                const markerPos = editMiniMapMarker.getPosition();
                position = {
                    lat: markerPos.lat(),
                    lng: markerPos.lng()
                };
            }
            
            // Update cry data
            const cryIndex = cries.findIndex(c => c.id === currentEditingCry.id);
            if (cryIndex !== -1) {
                cries[cryIndex] = {
                    ...cries[cryIndex],
                    timestamp: dateTime,
                    locationTag: locationTag,
                    description: description,
                    lat: position.lat,
                    lng: position.lng,
                    country: detectCountry(position.lat, position.lng),
                    rating: currentEditingCry.rating
                };
                
                localStorage.setItem('cries', JSON.stringify(cries));
                
                // Update marker on map
                const marker = mapMarkers.find(m => m.cryData.id === currentEditingCry.id);
                if (marker) {
                    marker.setPosition(position);
                    marker.cryData = cries[cryIndex];
                }
                
                // Update Firebase
                if (window.db) {
                    try {
                        await window.updateDoc(window.doc(window.db, 'cries', currentEditingCry.id), {
                            timestamp: dateTime,
                            locationTag: locationTag,
                            description: description,
                            lat: position.lat,
                            lng: position.lng,
                            country: cries[cryIndex].country,
                            rating: currentEditingCry.rating
                        });
                    } catch (error) {
                        console.error('Error updating cry:', error);
                    }
                }
                
                // Update stats
                await updateUserStats();
            }
            
            closeEditCryModal();
            
            // Refresh cries modal if it was open
            if (document.getElementById('criesModal').classList.contains('active')) {
                if (currentCriesTab === 'history') {
                    loadModalHistory();
                } else {
                    searchCriesModal();
                }
            }
            
            alert('Cry updated successfully!');
        };

        window.closeEditCryModal = function() {
            document.getElementById('editCryModal').classList.remove('active');
            currentEditingCry = null;
        };

        window.deleteCry = async function() {
            if (!currentViewingCry || !confirm('Are you sure you want to delete this cry? This action cannot be undone.')) return;
            
            // Remove from local data
            cries = cries.filter(c => c.id !== currentViewingCry.id);
            localStorage.setItem('cries', JSON.stringify(cries));
            
            // Remove marker from map
            const markerIndex = mapMarkers.findIndex(m => m.cryData.id === currentViewingCry.id);
            if (markerIndex !== -1) {
                mapMarkers[markerIndex].setMap(null);
                mapMarkers.splice(markerIndex, 1);
            }
            
            // Delete from Firebase
            if (window.db) {
                try {
                    await window.deleteDoc(window.doc(window.db, 'cries', currentViewingCry.id));
                    await updateUserStats();
                } catch (error) {
                    console.error('Error deleting cry:', error);
                }
            }
            
            closeCryInfo();
            updateProfileStats();
            
            // Refresh cries modal if it was open
            if (document.getElementById('criesModal').classList.contains('active')) {
                if (currentCriesTab === 'history') {
                    loadModalHistory();
                } else {
                    searchCriesModal();
                }
            }
            
            alert('Cry deleted successfully');
        };

        function addUserLocationMarker() {
            if (!map || !userLocation) return;
            
            new google.maps.Marker({
                position: userLocation,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#4285F4',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                },
                title: 'Your Location'
            });
        }

        // Filter Functions
        window.setFilter = function(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            applyFilter();
        };

        function applyFilter() {
            const privacySettings = JSON.parse(localStorage.getItem('privacySettings') || '{}');
            
            mapMarkers.forEach(marker => {
                let visible = true;
                const cry = marker.cryData;
                
                // Check if cry owner has private profile
                if (cry.userId !== currentUser?.uid && privacySettings.privateProfile) {
                    // If owner has private profile, only show to friends
                    visible = friends.some(friend => friend.uid === cry.userId);
                }
                
                // Apply current filter
                if (visible) {
                    if (currentFilter === 'friends' && isLoggedIn) {
                        visible = friends.some(friend => friend.uid === cry.userId);
                    } else if (currentFilter === 'mine' && isLoggedIn) {
                        visible = cry.userId === currentUser.uid;
                    }
                }
                
                // Check if user is blocked
                if (blockedUsers.includes(cry.userId)) {
                    visible = false;
                }
                
                marker.setVisible(visible);
            });
        }

        // Friend System
        async function loadFriendsAndNotifications() {
            if (!isLoggedIn || !window.db) return;

            try {
                // Load friend requests
                const requestsQuery = window.query(
                    window.collection(window.db, 'friendships'),
                    window.where('toUserId', '==', currentUser.uid),
                    window.where('status', '==', 'pending')
                );
                
                const requestsSnapshot = await window.getDocs(requestsQuery);
                friendRequests = [];
                
                for (const doc of requestsSnapshot.docs) {
                    const requestData = doc.data();
                    const senderDoc = await window.getDoc(window.doc(window.db, 'users', requestData.fromUserId));
                    if (senderDoc.exists()) {
                        friendRequests.push({
                            id: doc.id,
                            ...requestData,
                            senderInfo: senderDoc.data()
                        });
                    }
                }
                
                // Load following (people I follow)
                const followingQuery = window.query(
                    window.collection(window.db, 'friendships'),
                    window.where('fromUserId', '==', currentUser.uid),
                    window.where('status', '==', 'accepted')
                );
                
                const followingSnapshot = await window.getDocs(followingQuery);
                following = [];
                const followingIds = new Set();
                
                for (const doc of followingSnapshot.docs) {
                    const friendData = doc.data();
                    if (!followingIds.has(friendData.toUserId)) {
                        const friendDoc = await window.getDoc(window.doc(window.db, 'users', friendData.toUserId));
                        if (friendDoc.exists()) {
                            following.push(friendDoc.data());
                            followingIds.add(friendData.toUserId);
                        }
                    }
                }
                
                // Load followers (people following me)
                const followersQuery = window.query(
                    window.collection(window.db, 'friendships'),
                    window.where('toUserId', '==', currentUser.uid),
                    window.where('status', '==', 'accepted')
                );
                
                const followersSnapshot = await window.getDocs(followersQuery);
                followers = [];
                const followerIds = new Set();
                
                for (const doc of followersSnapshot.docs) {
                    const followerData = doc.data();
                    if (!followerIds.has(followerData.fromUserId)) {
                        const followerDoc = await window.getDoc(window.doc(window.db, 'users', followerData.fromUserId));
                        if (followerDoc.exists()) {
                            followers.push(followerDoc.data());
                            followerIds.add(followerData.fromUserId);
                        }
                    }
                }
                
                // Friends are mutual connections
                friends = following.filter(f => followers.some(follower => follower.uid === f.uid));
                
                updateNotificationBadge();
                updateProfileStats();
                
                // Update user stats in Firebase
                await window.updateDoc(window.doc(window.db, 'users', currentUser.uid), {
                    'stats.following': following.length,
                    'stats.followers': followers.length
                });
                
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        window.openAddFriendsModal = function() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            document.getElementById('addFriendsModal').classList.add('active');
        };

        window.closeAddFriendsModal = function() {
            document.getElementById('addFriendsModal').classList.remove('active');
            document.getElementById('friendSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
        };

        window.searchFriends = async function() {
            clearTimeout(searchTimeout);
            const query = document.getElementById('friendSearch').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            
            if (query.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">🔍</div><p>Searching...</p></div>';
            
            searchTimeout = setTimeout(async () => {
                try {
                    const usersQuery = window.query(
                        window.collection(window.db, 'users'),
                        window.where('username', '>=', query),
                        window.where('username', '<=', query + '\uf8ff'),
                        window.limit(10)
                    );
                    
                    const snapshot = await window.getDocs(usersQuery);
                    const results = [];
                    
                    snapshot.forEach((doc) => {
                        const userData = doc.data();
                        if (userData.uid !== currentUser.uid && !blockedUsers.includes(userData.uid)) {
                            results.push(userData);
                        }
                    });
                    
                    displaySearchResults(results);
                    
                } catch (error) {
                    console.error('Search error:', error);
                    resultsDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">😔</div><p>Search failed</p></div>';
                }
            }, 500);
        };

        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">😔</div><p>No users found</p></div>';
                return;
            }
            
            const html = results.map(user => {
                const isFollowing = following.some(f => f.uid === user.uid);
                const hasPendingRequest = friendRequests.some(r => r.fromUserId === user.uid);
                
                let buttonText = '+ Add Friend';
                let buttonClass = '';
                let onclick = `sendFriendRequest('${user.uid}')`;
                
                if (isFollowing) {
                    buttonText = '✓ Following';
                    buttonClass = 'friends';
                    onclick = `unfriendUser('${user.uid}')`;
                } else if (hasPendingRequest) {
                    buttonText = 'Pending';
                    buttonClass = 'pending';
                    onclick = '';
                }
                
                return `
                    <div class="search-result-item">
                        <div class="user-avatar" onclick="showUserProfile('${user.uid}')" style="cursor: pointer;">${user.username.charAt(0).toUpperCase()}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; cursor: pointer; color: #4A90E2;" onclick="showUserProfile('${user.uid}')">@${user.username}</div>
                            <div style="font-size: 12px; color: #999;">${user.email}</div>
                        </div>
                        <button class="add-friend-btn ${buttonClass}" onclick="${onclick}" ${!onclick ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');
            
            resultsDiv.innerHTML = html;
        }

        window.sendFriendRequest = async function(toUserId) {
            try {
                await window.addDoc(window.collection(window.db, 'friendships'), {
                    fromUserId: currentUser.uid,
                    toUserId: toUserId,
                    status: 'pending',
                    createdAt: new Date(),
                    fromUserInfo: {
                        username: currentUser.profileData?.username || currentUser.email?.split('@')[0],
                        email: currentUser.email
                    }
                });
                
                alert('Friend request sent!');
                
                // Refresh UI
                await loadFriendsAndNotifications();
                searchFriends(); // Refresh search results
                
                // Update user profile modal if viewing this user
                if (currentViewingUserId === toUserId) {
                    updateUserProfileActionButton(toUserId);
                }
                
            } catch (error) {
                console.error('Error sending request:', error);
                alert('Failed to send friend request');
            }
        };

        window.acceptFriendRequest = async function(requestId, fromUserId) {
            try {
                // Update request to accepted
                await window.updateDoc(window.doc(window.db, 'friendships', requestId), {
                    status: 'accepted',
                    acceptedAt: new Date()
                });
                
                alert('Friend request accepted!');
                await loadFriendsAndNotifications();
                loadNotifications();
                
                // Update user profile modal if viewing this user
                if (currentViewingUserId === fromUserId) {
                    updateUserProfileActionButton(fromUserId);
                }
                
                // Check social butterfly achievement
                if (friends.length >= 10) {
                    unlockAchievement('socialButterfly');
                }
                
            } catch (error) {
                console.error('Error accepting request:', error);
                alert('Failed to accept friend request');
            }
        };

        window.declineFriendRequest = async function(requestId) {
            try {
                await window.deleteDoc(window.doc(window.db, 'friendships', requestId));
                alert('Friend request declined');
                await loadFriendsAndNotifications();
                loadNotifications();
            } catch (error) {
                console.error('Error declining request:', error);
                alert('Failed to decline friend request');
            }
        };

        window.unfriendUser = async function(userId) {
            if (!confirm('Are you sure you want to unfollow this user?')) return;
            
            try {
                // Find and delete friendship document
                const q = window.query(
                    window.collection(window.db, 'friendships'),
                    window.where('fromUserId', '==', currentUser.uid),
                    window.where('toUserId', '==', userId)
                );
                
                const snapshot = await window.getDocs(q);
                
                const deletePromises = [];
                snapshot.forEach(doc => deletePromises.push(window.deleteDoc(doc.ref)));
                
                await Promise.all(deletePromises);
                
                alert('Unfollowed successfully');
                await loadFriendsAndNotifications();
                searchFriends(); // Refresh if in search
                
                // Update user profile modal if viewing this user
                if (currentViewingUserId === userId) {
                    updateUserProfileActionButton(userId);
                }
                
            } catch (error) {
                console.error('Error unfollowing:', error);
                alert('Failed to unfollow user');
            }
        };

        window.showFollowing = function() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            document.getElementById('friendsListTitle').textContent = 'Following';
            const content = document.getElementById('friendsListContent');
            
            if (following.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-icon">👥</div><p>You\'re not following anyone yet</p></div>';
            } else {
                content.innerHTML = following.map(user => `
                    <div class="search-result-item">
                        <div class="user-avatar" onclick="showUserProfile('${user.uid}')" style="cursor: pointer;">${user.username.charAt(0).toUpperCase()}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; cursor: pointer; color: #4A90E2;" onclick="showUserProfile('${user.uid}')">@${user.username}</div>
                            <div style="font-size: 12px; color: #999;">${user.email}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('friendsListModal').classList.add('active');
        };

        window.showFollowers = function() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            document.getElementById('friendsListTitle').textContent = 'Followers';
            const content = document.getElementById('friendsListContent');
            
            if (followers.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-icon">👥</div><p>No followers yet</p></div>';
            } else {
                content.innerHTML = followers.map(user => `
                    <div class="search-result-item">
                        <div class="user-avatar" onclick="showUserProfile('${user.uid}')" style="cursor: pointer;">${user.username.charAt(0).toUpperCase()}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; cursor: pointer; color: #4A90E2;" onclick="showUserProfile('${user.uid}')">@${user.username}</div>
                            <div style="font-size: 12px; color: #999;">${user.email}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('friendsListModal').classList.add('active');
        };

        window.closeFriendsListModal = function() {
            document.getElementById('friendsListModal').classList.remove('active');
        };

        // User Profile Viewing
        window.showUserProfile = async function(userId) {
            try {
                // Close any open modals first
                document.querySelectorAll('.modal').forEach(modal => {
                    if (modal.id !== 'userProfileModal') {
                        modal.classList.remove('active');
                    }
                });
                
                // Get user data from Firestore
                const userDoc = await window.getDoc(window.doc(window.db, 'users', userId));
                if (!userDoc.exists()) {
                    alert('User not found');
                    return;
                }
                
                const userData = userDoc.data();
                currentViewingUserId = userId;
                
                // Update modal content
                document.getElementById('userProfileTitle').textContent = `@${userData.username}`;
                document.getElementById('userProfileAvatar').textContent = userData.username.charAt(0).toUpperCase();
                document.getElementById('userProfileUsername').textContent = `@${userData.username}`;
                
                // Format member since date
                const memberSince = userData.createdAt ? 
                    new Date(userData.createdAt.seconds * 1000).toLocaleDateString() :
                    'Unknown';
                document.getElementById('userProfileMemberSince').textContent = `Member since ${memberSince}`;
                
                // Display bio
                const bio = userData.bio || '';
                document.getElementById('userProfileBio').textContent = bio;
                document.getElementById('userProfileBio').style.display = bio ? 'block' : 'none';
                
                // Load stats
                const userCries = cries.filter(cry => cry.userId === userId);
                document.getElementById('userProfileCries').textContent = userData.stats?.cries || userCries.length;
                document.getElementById('userProfileFollowing').textContent = userData.stats?.following || 0;
                document.getElementById('userProfileFollowers').textContent = userData.stats?.followers || 0;
                document.getElementById('userProfileCountries').textContent = userData.stats?.countries || 0;
                
                // Update action buttons
                updateUserProfileActionButton(userId);
                updateBlockButton(userId);
                
                // Show modal
                document.getElementById('userProfileModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading user profile:', error);
                alert('Failed to load user profile');
            }
        };

        function updateUserProfileActionButton(userId) {
            const actionBtn = document.getElementById('userProfileActionBtn');
            
            if (!isLoggedIn) {
                actionBtn.textContent = 'Sign in to follow';
                actionBtn.style.display = 'block';
                return;
            }
            
            if (userId === currentUser.uid) {
                actionBtn.style.display = 'none';
                document.getElementById('blockUserBtn').style.display = 'none';
                return;
            }
            
            actionBtn.style.display = 'block';
            
            // Check friendship status
            const isFollowing = following.some(f => f.uid === userId);
            const hasPendingRequest = friendRequests.some(r => r.fromUserId === userId);
            
            if (isFollowing) {
                actionBtn.textContent = '✓ Following';
                actionBtn.style.background = '#4CAF50';
            } else if (hasPendingRequest) {
                actionBtn.textContent = '💬 Respond to Request';
                actionBtn.style.background = '#4A90E2';
            } else {
                actionBtn.textContent = '+ Follow';
                actionBtn.style.background = 'linear-gradient(45deg, #FF6B35, #F7931E)';
            }
        }

        function updateBlockButton(userId) {
            const blockBtn = document.getElementById('blockUserBtn');
            
            if (userId === currentUser?.uid) {
                blockBtn.style.display = 'none';
                return;
            }
            
            const isBlocked = blockedUsers.includes(userId);
            blockBtn.textContent = isBlocked ? 'Unblock User' : 'Block User';
            blockBtn.style.display = isLoggedIn ? 'block' : 'none';
        }

        window.handleUserProfileAction = function() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            if (!currentViewingUserId) return;
            
            const isFollowing = following.some(f => f.uid === currentViewingUserId);
            const hasPendingRequest = friendRequests.some(r => r.fromUserId === currentViewingUserId);
            
            if (isFollowing) {
                unfriendUser(currentViewingUserId);
            } else if (hasPendingRequest) {
                const request = friendRequests.find(r => r.fromUserId === currentViewingUserId);
                if (request) {
                    acceptFriendRequest(request.id, currentViewingUserId);
                }
            } else {
                sendFriendRequest(currentViewingUserId);
            }
        };

        window.toggleBlockUser = async function() {
            if (!currentViewingUserId || !isLoggedIn) return;
            
            const isBlocked = blockedUsers.includes(currentViewingUserId);
            
            if (isBlocked) {
                // Unblock
                blockedUsers = blockedUsers.filter(id => id !== currentViewingUserId);
            } else {
                // Block
                if (confirm('Block this user? You won\'t see their cries or receive messages from them.')) {
                    blockedUsers.push(currentViewingUserId);
                    
                    // Also unfollow if following
                    if (following.some(f => f.uid === currentViewingUserId)) {
                        await unfriendUser(currentViewingUserId);
                    }
                }
            }
            
            localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
            updateBlockButton(currentViewingUserId);
            
            if (!isBlocked) {
                closeUserProfileModal();
                applyFilter(); // Update map
            }
        };

        window.closeUserProfileModal = function() {
            document.getElementById('userProfileModal').classList.remove('active');
            currentViewingUserId = null;
        };

        window.showUserFollowing = async function() {
            if (!currentViewingUserId) return;
            
            // For now, show privacy message
            document.getElementById('friendsListTitle').textContent = 'Following';
            document.getElementById('friendsListContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">🔒</div>
                    <h3>Private List</h3>
                    <p>Following lists are private.</p>
                </div>
            `;
            document.getElementById('friendsListModal').classList.add('active');
        };

        window.showUserFollowers = async function() {
            if (!currentViewingUserId) return;
            
            // For now, show privacy message
            document.getElementById('friendsListTitle').textContent = 'Followers';
            document.getElementById('friendsListContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">🔒</div>
                    <h3>Private List</h3>
                    <p>Follower lists are private.</p>
                </div>
            `;
            document.getElementById('friendsListModal').classList.add('active');
        };

        // Profile Functions
        function updateProfileInfo() {
            if (isLoggedIn && currentUser) {
                const username = currentUser.profileData?.username || 
                               currentUser.displayName || 
                               currentUser.email?.split('@')[0] || 'User';
                
                document.getElementById('profileUsername').textContent = '@' + username;
                document.getElementById('profileAvatar').textContent = username.charAt(0).toUpperCase();
                
                const memberSince = currentUser.profileData?.createdAt ? 
                    new Date(currentUser.profileData.createdAt.seconds * 1000).toLocaleDateString() :
                    new Date().toLocaleDateString();
                document.getElementById('memberSince').textContent = `Member since ${memberSince}`;
                
                // Display bio
                const bio = currentUser.profileData?.bio || '';
                document.getElementById('profileBio').textContent = bio;
                document.getElementById('profileBio').style.display = bio ? 'block' : 'none';
            } else {
                document.getElementById('profileUsername').textContent = 'Guest User';
                document.getElementById('profileAvatar').textContent = 'G';
                document.getElementById('memberSince').textContent = 'Not signed in';
                document.getElementById('profileBio').style.display = 'none';
            }
        }

        function updateProfileStats() {
            const userCries = cries.filter(cry => cry.userId === (currentUser?.uid || 'anonymous'));
            
            // Basic stats
            document.getElementById('statCries').textContent = userCries.length;
            document.getElementById('statFollowing').textContent = following.length;
            document.getElementById('statFollowers').textContent = followers.length;
            
            // Countries
            const countries = new Set(userCries.map(cry => cry.country).filter(c => c && c !== 'Unknown'));
            document.getElementById('statCountries').textContent = countries.size;
            
            // Calculate average rating
            const totalRating = userCries.reduce((sum, cry) => sum + (cry.rating || 0), 0);
            const avgRating = userCries.length > 0 ? (totalRating / userCries.length).toFixed(2) : '0.00';
            document.getElementById('statAvgRating').textContent = avgRating;
            
            // Time-based stats
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            const weeklyCries = userCries.filter(cry => new Date(cry.timestamp) > weekAgo).length;
            const monthlyCries = userCries.filter(cry => new Date(cry.timestamp) > monthAgo).length;
            
            document.getElementById('statCriesPerWeek').textContent = weeklyCries.toFixed(2);
            document.getElementById('statCriesPerMonth').textContent = monthlyCries.toFixed(2);
            document.getElementById('statCriesPerYear').textContent = (monthlyCries * 12).toFixed(2);
        }

        // Edit Profile
        window.openEditProfileModal = function() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            document.getElementById('editProfileModal').classList.add('active');
        };

        window.closeEditProfileModal = function() {
            document.getElementById('editProfileModal').classList.remove('active');
        };

        window.changePhoto = function() {
            alert('Photo upload feature coming soon!');
        };

        window.changeName = async function() {
            const newName = prompt('Enter your new display name:', currentUser.profileData?.displayName || '');
            if (newName && newName.trim()) {
                try {
                    await window.updateDoc(window.doc(window.db, 'users', currentUser.uid), {
                        displayName: newName.trim()
                    });
                    await window.updateProfile(currentUser, { displayName: newName.trim() });
                    await loadUserProfile();
                    alert('Name updated successfully!');
                } catch (error) {
                    alert('Failed to update name');
                }
            }
        };

        window.changeEmail = function() {
            alert('To change your email, please contact support@cryingmap.com');
        };

        window.changeUsername = async function() {
            const newUsername = prompt('Enter your new username:', currentUser.profileData?.username || '');
            if (!newUsername || !newUsername.trim()) return;
            
            const username = newUsername.trim().toLowerCase();
            if (username.length < 3) {
                alert('Username must be at least 3 characters long');
                return;
            }
            
            try {
                const isAvailable = await checkUsernameAvailability(username);
                if (!isAvailable) {
                    alert('Username is already taken');
                    return;
                }
                
                await window.updateDoc(window.doc(window.db, 'users', currentUser.uid), {
                    username: username
                });
                await loadUserProfile();
                alert('Username updated successfully!');
                closeEditProfileModal();
            } catch (error) {
                alert('Failed to update username');
            }
        };

        window.changeBio = async function() {
            const currentBio = currentUser.profileData?.bio || '';
            const newBio = prompt('Enter your bio (max 150 characters):', currentBio);
            if (newBio !== null) {
                const bio = newBio.trim().substring(0, 150);
                try {
                    await window.updateDoc(window.doc(window.db, 'users', currentUser.uid), {
                        bio: bio
                    });
                    await loadUserProfile();
                    alert('Bio updated successfully!');
                    closeEditProfileModal();
                } catch (error) {
                    alert('Failed to update bio');
                }
            }
        };

        // Share Profile
        window.shareProfile = function() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            const username = currentUser.profileData?.username || 'user';
            const shareText = `Check out my emotional journey on Crying Map! Follow me @${username}\n\nhttps://cryingmap.com/user/${username}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Crying Map Profile',
                    text: shareText
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(shareText);
                alert('Profile link copied to clipboard!');
            }
        };

        window.copyProfileLink = function() {
            if (!isLoggedIn) {
                showAuthModal();
                return;
            }
            
            const username = currentUser.profileData?.username || 'user';
            const profileUrl = `https://cryingmap.com/user/${username}`;
            
            navigator.clipboard.writeText(profileUrl);
            alert('Profile link copied!');
        };

        // Calendar Functions
        window.changeMonth = function(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            updateCalendar();
        };

        function updateCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Get user cries for this month
            const userCries = cries.filter(cry => {
                if (cry.userId !== (currentUser?.uid || 'anonymous')) return false;
                const cryDate = new Date(cry.timestamp);
                return cryDate.getFullYear() === year && cryDate.getMonth() === month;
            });
            
            // Create calendar grid
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                // Check if there are cries on this day
                const dayCries = userCries.filter(cry => {
                    const cryDate = new Date(cry.timestamp);
                    return cryDate.getDate() === day;
                });
                
                if (dayCries.length > 0) {
                    dayCell.classList.add('has-cry');
                    dayCell.innerHTML = `
                        <div class="calendar-day-number">${day}</div>
                        <div class="calendar-cry-count">${dayCries.length} ${dayCries.length === 1 ? 'cry' : 'cries'}</div>
                    `;
                    dayCell.onclick = () => showDayCries(year, month, day, dayCries);
                } else {
                    dayCell.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                }
                
                calendarGrid.appendChild(dayCell);
            }
        }

        function showDayCries(year, month, day, dayCries) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            alert(`Cries on ${monthNames[month]} ${day}, ${year}:\n\n` + 
                  dayCries.map(cry => `${cry.emoji} ${cry.name} - ${cry.locationTag || cry.country}`).join('\n'));
        }

        // History Functions
        function loadModalHistory() {
            const historyContainer = document.getElementById('modalHistoryContainer');
            const userCries = cries.filter(cry => cry.userId === (currentUser?.uid || 'anonymous'));
            
            if (userCries.length === 0) {
                historyContainer.innerHTML = '<div class="empty-state"><div class="empty-icon">📜</div><h3>No Cry History</h3><p>Your cries will appear here</p></div>';
                return;
            }
            
            // Sort by date (newest first)
            userCries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            historyContainer.innerHTML = userCries.map(cry => `
                <div class="history-item" onclick="showCryFromHistory('${cry.id}')">
                    <div class="history-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="history-emoji">${cry.emoji}</span>
                            <div>
                                <div style="font-weight: bold;">${cry.name}</div>
                                <div class="history-location">${cry.locationTag || cry.country || 'Unknown location'}</div>
                            </div>
                        </div>
                        <div class="history-date">${new Date(cry.timestamp).toLocaleDateString()}</div>
                    </div>
                    ${cry.description ? `<div style="color: #999; font-size: 14px; margin-top: 8px;">${cry.description}</div>` : ''}
                    <div class="history-actions">
                        <button class="history-action-btn" onclick="editCryFromHistory(event, '${cry.id}')">Edit</button>
                        <button class="history-action-btn" onclick="deleteCryFromHistory(event, '${cry.id}')" style="background: #ff4757;">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        window.showCryFromHistory = function(cryId) {
            const cry = cries.find(c => c.id === cryId);
            if (cry) {
                // Close cries modal
                closeCriesModal();
                
                // Switch to map page
                switchPage('mapPage');
                
                // Center map on cry
                if (map) {
                    map.setCenter({ lat: cry.lat, lng: cry.lng });
                    map.setZoom(16);
                }
                showCryInfo(cry);
            }
        };

        window.editCryFromHistory = function(event, cryId) {
            event.stopPropagation();
            const cry = cries.find(c => c.id === cryId);
            if (cry) {
                currentViewingCry = cry;
                closeCriesModal(); // Close cries modal
                editCry();
            }
        };

        window.deleteCryFromHistory = function(event, cryId) {
            event.stopPropagation();
            const cry = cries.find(c => c.id === cryId);
            if (cry) {
                currentViewingCry = cry;
                closeCriesModal(); // Close cries modal
                deleteCry();
            }
        };

        // Search Functions
        window.setSearchFilter = function(filter) {
            currentSearchFilter = filter;
            
            // Update all filter buttons
            document.querySelectorAll('.search-filter-btn').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        };

        window.searchCriesModal = function() {
            const searchTerm = document.getElementById('modalCrySearchInput')?.value?.toLowerCase() || '';
            const searchResults = document.getElementById('modalSearchResults');
            
            if (!searchResults) return;
            
            let userCries = cries.filter(cry => cry.userId === (currentUser?.uid || 'anonymous'));
            
            // Apply filter
            if (currentSearchFilter !== 'all') {
                const filterMap = {
                    'happy': ['😂'],
                    'sad': ['😢', '😭', '💔', '🥲'],
                    'angry': ['😤'],
                    'stressed': ['😰', '😩', '🫠']
                };
                
                const allowedEmojis = filterMap[currentSearchFilter] || [];
                userCries = userCries.filter(cry => allowedEmojis.includes(cry.emoji));
            }
            
            // Apply search term
            if (searchTerm) {
                userCries = userCries.filter(cry => 
                    cry.description?.toLowerCase().includes(searchTerm) ||
                    cry.locationTag?.toLowerCase().includes(searchTerm) ||
                    cry.country?.toLowerCase().includes(searchTerm) ||
                    cry.name?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Display results
            if (userCries.length === 0) {
                searchResults.innerHTML = '<div class="empty-state"><div class="empty-icon">🔍</div><p>No cries found</p></div>';
                return;
            }
            
            searchResults.innerHTML = userCries.map(cry => `
                <div class="history-item" onclick="showCryFromHistory('${cry.id}')">
                    <div class="history-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="history-emoji">${cry.emoji}</span>
                            <div>
                                <div style="font-weight: bold;">${cry.name}</div>
                                <div class="history-location">${cry.locationTag || cry.country || 'Unknown location'}</div>
                            </div>
                        </div>
                        <div class="history-date">${new Date(cry.timestamp).toLocaleDateString()}</div>
                    </div>
                    ${cry.description ? `<div style="color: #999; font-size: 14px; margin-top: 8px;">${cry.description}</div>` : ''}
                </div>
            `).join('');
        };

        // Achievement System
        function loadAchievements() {
            const savedAchievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            achievements = savedAchievements;
            updateAchievements();
        }

        function updateAchievements() {
            const achievementsGrid = document.getElementById('achievementsGrid');
            const userCries = cries.filter(cry => cry.userId === (currentUser?.uid || 'anonymous'));
            
            let unlockedCount = 0;
            const achievementHTML = [];
            
            for (const [key, achievement] of Object.entries(achievementDefinitions)) {
                const isUnlocked = achievements[key]?.unlocked || false;
                if (isUnlocked) unlockedCount++;
                
                let progress = 0;
                switch(key) {
                    case 'firstCry':
                    case 'fiveCries':
                    case 'tenCries':
                    case 'twentyFiveCries':
                    case 'fiftyCries':
                        progress = Math.min(userCries.length, achievement.target);
                        break;
                    case 'weekStreak':
                        progress = calculateWeekStreak();
                        break;
                    case 'nightOwl':
                        progress = userCries.some(cry => {
                            const hour = new Date(cry.timestamp).getHours();
                            return hour >= 0 && hour < 6;
                        }) ? 1 : 0;
                        break;
                    case 'earlyBird':
                        progress = userCries.some(cry => {
                            const hour = new Date(cry.timestamp).getHours();
                            return hour >= 4 && hour < 6;
                        }) ? 1 : 0;
                        break;
                    case 'socialButterfly':
                        progress = Math.min(friends.length, achievement.target);
                        break;
                    case 'worldTraveler':
                        const countries = new Set(userCries.map(cry => cry.country).filter(c => c && c !== 'Unknown'));
                        progress = Math.min(countries.size, achievement.target);
                        break;
                    case 'popularCry':
                        const maxLikes = Math.max(...userCries.map(cry => cry.likes?.length || 0), 0);
                        progress = Math.min(maxLikes, achievement.target);
                        break;
                    case 'commentator':
                        progress = Math.min(currentUser?.profileData?.stats?.totalComments || 0, achievement.target);
                        break;
                }
                
                const progressPercent = (progress / achievement.target) * 100;
                
                achievementHTML.push(`
                    <div class="achievement-item ${isUnlocked ? 'unlocked' : ''}" onclick="showAchievementDetails('${key}')">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-progress-bar">
                            <div class="achievement-progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                `);
            }
            
            achievementsGrid.innerHTML = achievementHTML.join('');
            document.getElementById('achievementProgress').textContent = `${unlockedCount}/${Object.keys(achievementDefinitions).length} unlocked`;
        }

        function calculateWeekStreak() {
            const userCries = cries.filter(cry => cry.userId === (currentUser?.uid || 'anonymous'));
            if (userCries.length === 0) return 0;
            
            // Sort cries by date
            const sortedCries = userCries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let streak = 0;
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < 7; i++) {
                const dayHasCry = sortedCries.some(cry => {
                    const cryDate = new Date(cry.timestamp);
                    cryDate.setHours(0, 0, 0, 0);
                    return cryDate.getTime() === currentDate.getTime();
                });
                
                if (dayHasCry) {
                    streak++;
                } else {
                    break;
                }
                
                currentDate.setDate(currentDate.getDate() - 1);
            }
            
            return streak;
        }

        function checkAchievements() {
            const userCries = cries.filter(cry => cry.userId === (currentUser?.uid || 'anonymous'));
            
            // First Cry
            if (userCries.length >= 1) unlockAchievement('firstCry');
            
            // Cry milestones
            if (userCries.length >= 5) unlockAchievement('fiveCries');
            if (userCries.length >= 10) unlockAchievement('tenCries');
            if (userCries.length >= 25) unlockAchievement('twentyFiveCries');
            if (userCries.length >= 50) unlockAchievement('fiftyCries');
            
            // Week Streak
            if (calculateWeekStreak() >= 7) unlockAchievement('weekStreak');
            
            // Night Owl
            if (userCries.some(cry => {
                const hour = new Date(cry.timestamp).getHours();
                return hour >= 0 && hour < 6;
            })) {
                unlockAchievement('nightOwl');
            }
            
            // Early Bird
            if (userCries.some(cry => {
                const hour = new Date(cry.timestamp).getHours();
                return hour >= 4 && hour < 6;
            })) {
                unlockAchievement('earlyBird');
            }
            
            // World Traveler
            const countries = new Set(userCries.map(cry => cry.country).filter(c => c && c !== 'Unknown'));
            if (countries.size >= 5) unlockAchievement('worldTraveler');
            
            updateAchievements();
        }

        function checkCommentAchievement() {
            const commentCount = currentUser?.profileData?.stats?.totalComments || 0;
            if (commentCount >= 20) unlockAchievement('commentator');
        }

        function unlockAchievement(key) {
            if (!achievements[key]?.unlocked) {
                achievements[key] = {
                    unlocked: true,
                    unlockedAt: new Date()
                };
                localStorage.setItem('achievements', JSON.stringify(achievements));
                
                // Show notification
                const achievement = achievementDefinitions[key];
                alert(`🎉 Achievement Unlocked!\n\n${achievement.icon} ${achievement.name}\n${achievement.description}`);
                
                updateAchievements();
            }
        }

        window.showAchievementDetails = function(key) {
            const achievement = achievementDefinitions[key];
            const userAchievement = achievements[key];
            
            document.getElementById('achievementDetailsTitle').textContent = achievement.name;
            document.getElementById('achievementDetailsIcon').textContent = achievement.icon;
            document.getElementById('achievementDetailsName').textContent = achievement.name;
            document.getElementById('achievementDetailsDescription').textContent = achievement.description;
            
            // Calculate progress
            const userCries = cries.filter(cry => cry.userId === (currentUser?.uid || 'anonymous'));
            let progress = 0;
            
            switch(key) {
                case 'firstCry':
                case 'fiveCries':
                case 'tenCries':
                case 'twentyFiveCries':
                case 'fiftyCries':
                    progress = Math.min(userCries.length, achievement.target);
                    break;
                case 'weekStreak':
                    progress = calculateWeekStreak();
                    break;
                case 'nightOwl':
                    progress = userCries.some(cry => {
                        const hour = new Date(cry.timestamp).getHours();
                        return hour >= 0 && hour < 6;
                    }) ? 1 : 0;
                    break;
                case 'earlyBird':
                    progress = userCries.some(cry => {
                        const hour = new Date(cry.timestamp).getHours();
                        return hour >= 4 && hour < 6;
                    }) ? 1 : 0;
                    break;
                case 'socialButterfly':
                    progress = Math.min(friends.length, achievement.target);
                    break;
                case 'worldTraveler':
                    const countries = new Set(userCries.map(cry => cry.country).filter(c => c && c !== 'Unknown'));
                    progress = Math.min(countries.size, achievement.target);
                    break;
                case 'popularCry':
                    const maxLikes = Math.max(...userCries.map(cry => cry.likes?.length || 0), 0);
                    progress = Math.min(maxLikes, achievement.target);
                    break;
                case 'commentator':
                    progress = Math.min(currentUser?.profileData?.stats?.totalComments || 0, achievement.target);
                    break;
            }
            
            const progressPercent = (progress / achievement.target) * 100;
            document.getElementById('achievementDetailsFill').style.width = `${progressPercent}%`;
            document.getElementById('achievementDetailsStatus').textContent = `${progress}/${achievement.target}`;
            
            if (userAchievement?.unlocked) {
                document.getElementById('achievementDetailsUnlocked').style.display = 'block';
                document.getElementById('unlockedDate').textContent = new Date(userAchievement.unlockedAt).toLocaleDateString();
                document.getElementById('achievementDetailsProgress').style.display = 'none';
            } else {
                document.getElementById('achievementDetailsUnlocked').style.display = 'none';
                document.getElementById('achievementDetailsProgress').style.display = 'block';
            }
            
            document.getElementById('achievementDetailsModal').classList.add('active');
        };

        window.closeAchievementDetails = function() {
            document.getElementById('achievementDetailsModal').classList.remove('active');
        };

        // Feed Functions
        function loadFeed() {
            const feedLoginRequired = document.getElementById('feedLoginRequired');
            const feedEmpty = document.getElementById('feedEmpty');
            const feedContent = document.getElementById('feedContent');
            
            if (!isLoggedIn) {
                feedLoginRequired.style.display = 'block';
                feedEmpty.style.display = 'none';
                feedContent.innerHTML = '';
                return;
            }
            
            feedLoginRequired.style.display = 'none';
            
            if (following.length === 0) {
                feedEmpty.style.display = 'block';
                feedContent.innerHTML = '';
            } else {
                feedEmpty.style.display = 'none';
                loadFriendsCries();
            }
        }

        async function loadFriendsCries() {
            const feedContent = document.getElementById('feedContent');
            feedContent.innerHTML = '<div class="empty-state"><div class="empty-icon">⏳</div><p>Loading friend updates...</p></div>';
            
            try {
                // Get friend cries
                const friendCries = cries.filter(cry => 
                    following.some(friend => friend.uid === cry.userId) && 
                    !blockedUsers.includes(cry.userId)
                ).slice(0, 20); // Last 20 cries
                
                if (friendCries.length === 0) {
                    feedContent.innerHTML = '<div class="empty-state"><div class="empty-icon">😢</div><p>No recent cries from friends</p></div>';
                    return;
                }
                
                const html = friendCries.map(cry => {
                    const friend = following.find(f => f.uid === cry.userId);
                    const username = friend?.username || 'Unknown';
                    const timeAgo = getTimeAgo(new Date(cry.timestamp));
                    const likeCount = cry.likes?.length || 0;
                    const commentCount = cry.comments?.length || 0;
                    
                    return `
                        <div class="feed-item">
                            <div class="feed-header">
                                <div class="user-avatar" onclick="showUserProfile('${cry.userId}')" style="cursor: pointer;">${username.charAt(0).toUpperCase()}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; cursor: pointer; color: #4A90E2;" onclick="showUserProfile('${cry.userId}')">@${username}</div>
                                    <div style="font-size: 12px; color: #999;">${timeAgo}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px; cursor: pointer;" onclick="showCryInfo(cries.find(c => c.id === '${cry.id}'))">
                                <div style="font-size: 30px;">${cry.emoji}</div>
                                <div>
                                    <h4 style="margin: 0;">${cry.name}</h4>
                                    <div style="color: #ccc; font-size: 14px;">${cry.locationTag || 'Unknown location'}</div>
                                    ${cry.description ? `<div style="color: #aaa; font-style: italic; font-size: 14px; margin-top: 5px;">"${cry.description}"</div>` : ''}
                                    <div style="display: flex; gap: 15px; margin-top: 8px; color: #999; font-size: 12px;">
                                        <span>❤️ ${likeCount}</span>
                                        <span>💬 ${commentCount}</span>
                                        <span>⭐ ${cry.rating || 0}/5</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                feedContent.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading feed:', error);
                feedContent.innerHTML = '<div class="empty-state"><div class="empty-icon">😔</div><p>Failed to load feed</p></div>';
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };
            
            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
                }
            }
            
            return 'just now';
        }

        // Notifications
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const count = friendRequests.length;
            
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function loadNotifications() {
            const notificationsEmpty = document.getElementById('notificationsEmpty');
            const notificationsContent = document.getElementById('notificationsContent');
            
            if (!isLoggedIn || friendRequests.length === 0) {
                notificationsEmpty.style.display = 'block';
                notificationsContent.innerHTML = '';
                return;
            }
            
            notificationsEmpty.style.display = 'none';
            
            const html = friendRequests.map(request => `
                <div class="friend-request-item">
                    <div class="feed-header">
                        <div class="user-avatar" onclick="showUserProfile('${request.fromUserId}')" style="cursor: pointer;">${request.senderInfo.username.charAt(0).toUpperCase()}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; cursor: pointer; color: #4A90E2;" onclick="showUserProfile('${request.fromUserId}')">@${request.senderInfo.username}</div>
                            <div style="font-size: 12px; color: #999;">Wants to follow you</div>
                        </div>
                    </div>
                    <div class="friend-request-actions">
                        <button class="accept-btn" onclick="acceptFriendRequest('${request.id}', '${request.fromUserId}')">
                            Accept
                        </button>
                        <button class="decline-btn" onclick="declineFriendRequest('${request.id}')">
                            Decline
                        </button>
                    </div>
                </div>
            `).join('');
            
            notificationsContent.innerHTML = html;
        }

        // Settings Modals
        window.openPrivacySettings = function() {
            loadSettings(); // Reload settings to ensure toggles are in correct state
            document.getElementById('privacySettingsModal').classList.add('active');
        };

        window.closePrivacySettings = function() {
            document.getElementById('privacySettingsModal').classList.remove('active');
        };

        window.openBlockedUsers = function() {
            loadBlockedUsersList();
            document.getElementById('blockedUsersModal').classList.add('active');
        };

        function loadBlockedUsersList() {
            const blockedUsersList = document.getElementById('blockedUsersList');
            
            if (blockedUsers.length === 0) {
                blockedUsersList.innerHTML = '<div class="empty-state"><div class="empty-icon">🚫</div><h3>No blocked users</h3><p>You haven\'t blocked anyone yet</p></div>';
                return;
            }
            
            // For now, show blocked user IDs (in real app, would fetch user data)
            blockedUsersList.innerHTML = blockedUsers.map(userId => `
                <div class="blocked-user-item">
                    <div>
                        <div style="font-weight: bold;">User ID: ${userId}</div>
                        <div style="font-size: 12px; color: #999;">Blocked user</div>
                    </div>
                    <button class="unblock-btn" onclick="unblockUser('${userId}')">Unblock</button>
                </div>
            `).join('');
        }

        window.unblockUser = function(userId) {
            if (confirm('Unblock this user?')) {
                blockedUsers = blockedUsers.filter(id => id !== userId);
                localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
                loadBlockedUsersList();
                applyFilter(); // Update map
            }
        };

        window.closeBlockedUsers = function() {
            document.getElementById('blockedUsersModal').classList.remove('active');
        };

        window.openNotificationSettings = function() {
            loadSettings(); // Reload settings to ensure toggles are in correct state
            document.getElementById('notificationSettingsModal').classList.add('active');
        };

        window.closeNotificationSettings = function() {
            document.getElementById('notificationSettingsModal').classList.remove('active');
        };

        window.openFeedSettings = function() {
            loadSettings(); // Reload settings to ensure toggles are in correct state
            document.getElementById('feedSettingsModal').classList.add('active');
        };

        window.closeFeedSettings = function() {
            document.getElementById('feedSettingsModal').classList.remove('active');
        };

        window.openStatisticsModal = function() {
            // Calculate statistics
            const userCries = cries.filter(cry => cry.userId === (currentUser?.uid || 'anonymous'));
            
            if (userCries.length > 0) {
                const firstCry = userCries[userCries.length - 1];
                const startDate = new Date(firstCry.timestamp).toLocaleDateString();
                const daysActive = Math.floor((new Date() - new Date(firstCry.timestamp)) / (1000 * 60 * 60 * 24));
                const countries = new Set(userCries.map(cry => cry.country).filter(c => c && c !== 'Unknown'));
                
                // Calculate total likes and comments
                const totalLikes = userCries.reduce((sum, cry) => sum + (cry.likes?.length || 0), 0);
                const totalComments = userCries.reduce((sum, cry) => sum + (cry.comments?.length || 0), 0);
                
                document.getElementById('statsStartDate').textContent = startDate;
                document.getElementById('statsDaysActive').textContent = `${daysActive} days`;
                document.getElementById('statsCountriesVisited').textContent = `${countries.size} countries`;
                document.getElementById('statsTotalLikes').textContent = `${totalLikes} likes`;
                document.getElementById('statsTotalComments').textContent = `${totalComments} comments`;
            } else {
                document.getElementById('statsStartDate').textContent = 'Not started';
                document.getElementById('statsDaysActive').textContent = '0 days';
                document.getElementById('statsCountriesVisited').textContent = '0 countries';
                document.getElementById('statsTotalLikes').textContent = '0 likes';
                document.getElementById('statsTotalComments').textContent = '0 comments';
            }
            
            document.getElementById('statisticsModal').classList.add('active');
        };

        window.closeStatisticsModal = function() {
            document.getElementById('statisticsModal').classList.remove('active');
        };

        window.resetStatistics = function() {
            if (!confirm('Are you sure you want to reset all statistics? This will delete all your cries permanently.')) {
                return;
            }
            
            if (!confirm('This action cannot be undone. Are you absolutely sure?')) {
                return;
            }
            
            // Remove user's cries
            cries = cries.filter(cry => cry.userId !== (currentUser?.uid || 'anonymous'));
            localStorage.setItem('cries', JSON.stringify(cries));
            
            // Clear markers from map
            mapMarkers.forEach(marker => {
                if (marker.cryData.userId === (currentUser?.uid || 'anonymous')) {
                    marker.setMap(null);
                }
            });
            mapMarkers = mapMarkers.filter(marker => marker.cryData.userId !== (currentUser?.uid || 'anonymous'));
            
            // Reset achievements
            achievements = {};
            localStorage.setItem('achievements', JSON.stringify(achievements));
            
            // Update UI
            updateProfileStats();
            updateAchievements();
            closeStatisticsModal();
            alert('All statistics have been reset');
        };

        window.exportData = function() {
            const userCries = cries.filter(cry => cry.userId === (currentUser?.uid || 'anonymous'));
            const countries = new Set(userCries.map(cry => cry.country).filter(c => c && c !== 'Unknown'));
            
            const exportData = {
                user: {
                    email: currentUser?.email || 'anonymous',
                    username: currentUser?.profileData?.username || 'anonymous',
                    memberSince: currentUser?.profileData?.createdAt ? 
                        new Date(currentUser.profileData.createdAt.seconds * 1000).toISOString() : 
                        new Date().toISOString()
                },
                stats: {
                    totalCries: userCries.length,
                    countries: countries.size,
                    following: following.length,
                    followers: followers.length,
                    avgRating: document.getElementById('statAvgRating').textContent
                },
                cries: userCries,
                achievements: achievements,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crying_map_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.exportDataCSV = function() {
            const userCries = cries.filter(cry => cry.userId === (currentUser?.uid || 'anonymous'));
            
            if (userCries.length === 0) {
                alert('No cries to export');
                return;
            }
            
            // Create CSV header
            const headers = ['Date', 'Time', 'Emoji', 'Name', 'Rating', 'Location Tag', 'Country', 'Latitude', 'Longitude', 'Description', 'Likes', 'Comments'];
            
            // Create CSV rows
            const rows = userCries.map(cry => {
                const date = new Date(cry.timestamp);
                return [
                    date.toLocaleDateString(),
                    date.toLocaleTimeString(),
                    cry.emoji,
                    cry.name,
                    cry.rating || 0,
                    cry.locationTag || '',
                    cry.country || 'Unknown',
                    cry.lat,
                    cry.lng,
                    cry.description || '',
                    cry.likes?.length || 0,
                    cry.comments?.length || 0
                ];
            });
            
            // Convert to CSV format
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crying_map_data_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // External Links
        window.openLink = function(url) {
            window.open(url, '_blank');
        };

        window.reportProblem = function() {
            const email = 'support@cryingmap.com';
            const subject = 'Problem Report';
            const body = 'Describe the problem you encountered:\n\n';
            window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        };

        window.makeSuggestion = function() {
            const email = 'support@cryingmap.com';
            const subject = 'Feature Suggestion';
            const body = 'I have a suggestion for Crying Map:\n\n';
            window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        };

        window.requestAccountDeletion = function() {
            if (confirm('Are you sure you want to request account deletion? This action cannot be undone.')) {
                alert('Account deletion request submitted. You will receive an email with further instructions within 48 hours.');
            }
        };

        // Utility Functions
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const element = document.getElementById('currentDateTime');
            if (element) {
                element.textContent = `Now • ${dateStr} • ${timeStr}`;
            }
        }

        function requestLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        if (map) {
                            map.setCenter(userLocation);
                            addUserLocationMarker();
                        }
                    },
                    error => {
                        console.log('Location denied:', error);
                        userLocation = { lat: 55.6761, lng: 12.5683 }; // Copenhagen
                    }
                );
            }
        }

        function updateUI() {
            updatePageHeader();
            updateProfileInfo();
            
            if (currentPage === 'feedPage') loadFeed();
            if (currentPage === 'notificationsPage') loadNotifications();
            if (currentPage === 'profilePage') {
                updateProfileStats();
                updateAchievements();
            }
        }

        // Update datetime every minute
        setInterval(updateDateTime, 60000);
    </script>
</body>
</html>